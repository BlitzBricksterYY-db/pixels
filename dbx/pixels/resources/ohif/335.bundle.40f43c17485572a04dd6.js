"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[335],{98335:(e,t,a)=>{a.r(t),a.d(t,{ContextMenuController:()=>Wt,CustomizableContextMenuTypes:()=>n,createReportAsync:()=>rt,createReportDialogPrompt:()=>nt,default:()=>Va,dicomWebUtils:()=>s,getStudiesForPatientByMRN:()=>Je});var n={};a.r(n);var s={};a.r(s),a.d(s,{fixBulkDataURI:()=>R});var r=a(36922),i=a(14283),o=a(45476);const{getString:c,getName:l,getModalities:u}=i.DICOMWeb;function d(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),date:c(e["00080020"]),time:c(e["00080030"]),accession:c(e["00080050"])||"",mrn:c(e["00100020"])||"",patientName:i.utils.formatPN(l(e["00100010"]))||"",instances:Number(c(e["00201208"]))||0,description:c(e["00081030"])||"",modalities:c(u(e["00080060"],e["00080061"]))||""}))),t}async function m(e,t,a,n){return await e.searchForStudies({studyInstanceUid:void 0,queryParams:n})}function p(e,t={}){if(!e)return;const a=["00081030","00080060"].join(","),{supportsWildcard:n}=t,s=e=>n&&e?`*${e}*`:e,r={PatientName:s(e.patientName),"00100020":s(e.patientId),AccessionNumber:s(e.accessionNumber),StudyDescription:s(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)r.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),s=`${t.getFullYear()}${n}${a}`;r.StudyDate=`${e.startDate}-${s}`}else if(e.endDate){const t="19700102";r.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),r.StudyInstanceUID=t}const i={};return Object.keys(r).forEach((e=>{void 0!==r[e]&&""!==r[e]&&(i[e]=r[e])})),i}function g({instance:e,frame:t,config:a,thumbnail:n=!1}){if(!e)return;if(e.url)return e.url;const s=n?"thumbnailRendering":"imageRendering";if(a[s]&&"wadouri"!==a[s])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${s}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(e,a,t);{const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=[];r.push("requestType=WADO"),r.push(`studyUID=${a}`),r.push(`seriesUID=${n}`),r.push(`objectUID=${s}`),r.push("contentType=application/dicom"),r.push("transferSyntax=*");const i=r.join("&");return`${e.wadoUriRoot}?${i}`}(a,e);let s="dicomweb:"+n;return void 0!==t&&(s+="&frame="+t),s}}var I=a(31426);class f{constructor(e,t,a={},n=void 0,s=void 0){this.client=e,this.studyInstanceUID=t,this.filters=a,this.sortCriteria=n,this.sortFunction=s}async execLoad(){const e=await this.preLoad(),t=await this.load(e);return await this.posLoad(t)}async runLoaders(e){let t;for(const a of e)if(t=await a(),t&&t.length)break;if(e.next().done&&!t)throw new Error("RetrieveMetadataLoader failed");return t}async configLoad(){}async preLoad(){}async load(e){}async posLoad(e){}}class S extends f{getOptions(){const{studyInstanceUID:e,filters:t}=this,a={studyInstanceUID:e},{seriesInstanceUID:n}=t;return n&&(a.seriesInstanceUID=n),a}*getLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;a&&e.push(n.retrieveSeriesMetadata.bind(n,{studyInstanceUID:t,seriesInstanceUID:a})),e.push(n.retrieveStudyMetadata.bind(n,{studyInstanceUID:t})),yield*e}async load(e){const t=this.getLoaders();return this.runLoaders(t)}async posLoad(e){return e}}const y=["00080021","00080031","0008103E","00200011"].join(",");class h{constructor(){this.metadata=void 0,this.processFunction=void 0,this.internalPromise=void 0,this.thenFunction=void 0,this.rejectFunction=void 0}setMetadata(e){this.metadata=e}setProcessFunction(e){this.processFunction=e}getPromise(){return this.start()}start(){return this.internalPromise||(this.internalPromise=this.processFunction(),this.thenFunction&&(this.then(this.thenFunction),this.thenFunction=void 0),this.rejectFunction&&(this.reject(this.rejectFunction),this.rejectFunction=void 0)),this.internalPromise}then(e){if(this.internalPromise)return this.internalPromise.then(e);this.thenFunction=e}reject(e){if(this.internalPromise)return this.internalPromise.reject(e);this.rejectFunction=e}}class D extends f{*getPreLoaders(){const e=[],{studyInstanceUID:t,filters:{seriesInstanceUID:a}={},client:n}=this;let s={studyInstanceUID:t,queryParams:{includefield:y}};a&&(s.queryParams.SeriesInstanceUID=a,e.push(n.searchForSeries.bind(n,s))),e.push(n.searchForSeries.bind(n,s)),yield*e}async preLoad(){const e=this.getPreLoaders(),t=await this.runLoaders(e),a=this.sortCriteria,n=this.sortFunction,{naturalizeDataset:s}=I.Ay.data.DicomMetaDictionary,r=t.map(s);return(0,o.LM)(r,a,n)}async load(e){const{client:t,studyInstanceUID:a}=this,n=function(e,t,a){return Object.freeze({hasNext:()=>a.length>0,next(){const{seriesInstanceUID:n,metadata:s}=a.shift(),r=new h;return r.setMetadata(s),r.setProcessFunction((()=>e.retrieveSeriesMetadata({studyInstanceUID:t,seriesInstanceUID:n}))),r}})}(t,a,e.map((e=>({seriesInstanceUID:e.SeriesInstanceUID,metadata:e})))),s=[];for(;n.hasNext();){const e=n.next();s.push(e)}return{preLoadData:e,promises:s}}async posLoad({preLoadData:e,promises:t}){return{preLoadData:e,promises:t}}}const v=async function(e,t,a,n={},s,r){const i=new(!1!==a?D:S)(e,t,n,s,r);return await i.execLoad()};const b=function(e,t,a,n,s,r){const{SeriesInstanceUIDs:i}=n;return new Promise(((o,c)=>{const l=i.map((i=>{const o=Object.assign({},n,{seriesInstanceUID:i});return v(e,t,a,o,s,r)}));Promise.all(l).then((e=>{const t={preLoadData:[],promises:[]};e.forEach((({preLoadData:e,promises:a})=>{t.preLoadData=t.preLoadData.concat(e),t.promises=t.promises.concat(a)})),o(t)}),c)}))},w="RetrieveStudyMetadata",E=new Map;function U(e,t,a,n,s,r,i={}){if(!e)throw new Error(`${w}: Required 'dicomWebClient' parameter not provided.`);if(!t)throw new Error(`${w}: Required 'StudyInstanceUID' parameter not provided.`);const o=`${i.name}:${t}`;if(E.has(o))return E.get(o);let c;return c=n&&n.SeriesInstanceUIDs?b(e,t,a,n,s,r):new Promise(((i,o)=>{v(e,t,a,n,s,r).then((function(e){i(e)}),o)})),E.set(o,c),c}function M(e){E.has(e)&&E.delete(e)}class N extends r.FH.DICOMwebClient{constructor(e){super(e),this.staticWado=e.staticWado}async searchForStudies(e){if(!this.staticWado)return super.searchForStudies(e);const t=await super.searchForStudies(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(N.studyFilterKeys))if(!this.filterItem(t,n,e,N.studyFilterKeys))return!1;return!0}))}async searchForSeries(e){if(!this.staticWado)return super.searchForSeries(e);const t=await super.searchForSeries(e),{queryParams:a}=e;if(!a)return t;const n=this.toLowerParams(a);return t.filter((e=>{for(const t of Object.keys(N.seriesFilterKeys))if(!this.filterItem(t,n,e,N.seriesFilterKeys))return!1;return!0}))}compareValues(e,t){if(Array.isArray(e))return e.find((e=>this.compareValues(e,t)));if(Array.isArray(t))return t.find((t=>this.compareValues(e,t)));if(t?.Alphabetic&&(t=t.Alphabetic),"string"==typeof t){if(0===t.length)return!0;if(0===e.length||"*"===e)return!0;if("*"===e[0]&&"*"===e[e.length-1])return-1!=t.indexOf(e.substring(1,e.length-1));if("*"===e[e.length-1])return-1!=t.indexOf(e.substring(0,e.length-1));if("*"===e[0])return t.indexOf(e.substring(1))===t.length-e.length+1}return e===t}compareDateRange(e,t){if(!t)return!0;const a=e.indexOf("-");if(-1===a)return this.compareValues(e,t);const n=e.substring(0,a),s=e.substring(a+1);return(!n||t>=n)&&(!s||t<=s)}filterItem(e,t,a,n){const s=n[e]||e;if(!t)return!0;const r=t[e]||t[s];if(!r)return!0;const i=a[e]||a[s];if(!i)return!1;if("DA"===i.vr&&i.Value?.[0])return this.compareDateRange(r,i.Value[0]);const o=i.Value;return this.compareValues(r,o)}toLowerParams(e){const t={};return Object.entries(e).forEach((([e,a])=>{t[e.toLowerCase()]=a})),t}}N.studyFilterKeys={studyinstanceuid:"0020000D",patientname:"00100010","00100020":"mrn",studydescription:"00081030",studydate:"00080020",modalitiesinstudy:"00080061",accessionnumber:"00080050"},N.seriesFilterKeys={seriesinstanceuid:"0020000E",seriesnumber:"00200011",modality:"00080060"};const x=(e,t)=>{const{wadoRoot:a,singlepart:n}=e,{instance:s,tag:r="PixelData",defaultPath:o="/pixeldata",defaultType:c="video/mp4",singlepart:l="video"}=t,u=s[r];if(!u)return;if(u.DirectRetrieveURL)return u.DirectRetrieveURL;if(u.InlineBinary){const e=i.utils.b64toBlob(u.InlineBinary,c);return u.DirectRetrieveURL=URL.createObjectURL(e),u.DirectRetrieveURL}if(!n||!0!==n&&-1===n.indexOf(l)){if(u.retrieveBulkData){const e={mediaType:c};return u.retrieveBulkData(e).then((e=>(u.DirectRetrieveURL=URL.createObjectURL(new Blob([e],{type:c})),u.DirectRetrieveURL)))}return void console.warn("Unable to retrieve",r,"from",s)}const{StudyInstanceUID:d,SeriesInstanceUID:m,SOPInstanceUID:p}=s,g=u&&u.BulkDataURI||`series/${m}/instances/${p}${o}`,I=-1!==g.indexOf("?"),f=-1!==g.indexOf("accept=");return"PixelData"===r||"EncapsulatedDocument"===r?`${a}/studies/${d}/series/${m}/instances/${p}/rendered`:g+(f?"":(I?"&":"?")+`accept=${c}`)};function R(e,t,a){if(e.BulkDataURI.startsWith("http")||e.BulkDataURI.startsWith("/")){if("/"===e.BulkDataURI[0]&&a.wadoRoot.startsWith("http")){const t=new URL(a.wadoRoot);e.BulkDataURI=`${t.origin}${e.BulkDataURI}`}}else"studies"===a.bulkDataURI?.relativeResolution?e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/${e.BulkDataURI}`:"series"!==a.bulkDataURI?.relativeResolution&&a.bulkDataURI?.relativeResolution||(e.BulkDataURI=`${a.wadoRoot}/studies/${t.StudyInstanceUID}/series/${t.SeriesInstanceUID}/${e.BulkDataURI}`)}const{DicomMetaDictionary:C,DicomDict:P}=I.Ay.data,{naturalizeDataset:A,denaturalizeDataset:O}=C,T="2.25.270695996825855179949881587723571202391.2.0.0",F="OHIF-VIEWER-2.0.0",L="1.2.840.10008.1.2.1",k=i.classes.MetadataProvider;function V(e,t){const{userAuthenticationService:a,customizationService:n}=t.services;let s,l,u,I,f,S,y;const h={initialize:({params:t,query:n})=>{e.onConfiguration&&"function"==typeof e.onConfiguration&&(e=e.onConfiguration(e,{params:t,query:n})),s=JSON.parse(JSON.stringify(e)),S=()=>{const e={},t=a.getAuthorizationHeader();return t&&t.Authorization&&(e.Authorization=t.Authorization),e},y=()=>({...S(),Accept:i.utils.generateAcceptHeader(e.acceptHeader,e.requestTransferSyntaxUID,e.omitQuotationForMultipartRequest)}),l={url:e.qidoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:a.getAuthorizationHeader(),errorInterceptor:i.r_.getHTTPErrorHandler()},u={url:e.wadoRoot,staticWado:e.staticWado,singlepart:e.singlepart,headers:a.getAuthorizationHeader(),errorInterceptor:i.r_.getHTTPErrorHandler()},I=e.staticWado?new N(l):new r.FH.DICOMwebClient(l),f=e.staticWado?new N(u):new r.FH.DICOMwebClient(u)},query:{studies:{mapParams:p.bind(),search:async function(t){I.headers=S();const{studyInstanceUid:a,seriesInstanceUid:n,...s}=p(t,{supportsFuzzyMatching:e.supportsFuzzyMatching,supportsWildcard:e.supportsWildcard})||{};return d(await m(I,0,0,s))},processResults:d.bind()},series:{search:async function(e){I.headers=S();return function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:c(e["0020000D"]),seriesInstanceUid:c(e["0020000E"]),modality:c(e["00080060"]),seriesNumber:c(e["00200011"]),seriesDate:i.utils.formatDate(c(e["00080021"])),numSeriesInstances:Number(c(e["00201209"])),description:c(e["0008103E"])}))),(0,o.LM)(t),t}(await function(e,t){const a={includefield:["0008103E","00080021"].join(",")};return e.searchForSeries({studyInstanceUID:t,queryParams:a})}(I,e))}},instances:{search:(e,t)=>(I.headers=S(),m.call(void 0,I,e,null,t))}},retrieve:{directURL:t=>x({wadoRoot:e.wadoRoot,singlepart:e.singlepart},t),bulkDataURI:async({StudyInstanceUID:e,BulkDataURI:t})=>{I.headers=S();const a={multipart:!1,BulkDataURI:t,StudyInstanceUID:e};return I.retrieveBulkData(a).then((e=>e&&e[0]||void 0))},series:{metadata:async({StudyInstanceUID:t,filters:a,sortCriteria:n,sortFunction:s,madeInClient:r=!1,returnPromises:i=!1}={})=>{if(!t)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");return e.enableStudyLazyLoad?h._retrieveSeriesMetadataAsync(t,a,n,s,r,i):h._retrieveSeriesMetadataSync(t,a,n,s,r)}}},store:{dicom:async(e,t,a)=>{if(f.headers=S(),e instanceof ArrayBuffer){const a={datasets:[e],request:t};await f.storeInstances(a)}else{let n=a;if(!a){const t={FileMetaInformationVersion:e._meta?.FileMetaInformationVersion?.Value,MediaStorageSOPClassUID:e.SOPClassUID,MediaStorageSOPInstanceUID:e.SOPInstanceUID,TransferSyntaxUID:L,ImplementationClassUID:T,ImplementationVersionName:F},a=O(t),s=new P(a);s.dict=O(e),n=s}const s={datasets:[n.write()],request:t};await f.storeInstances(s)}}},_retrieveSeriesMetadataSync:async(t,a,n,s,r)=>{f.headers=y();const o=(await U(f,t,!1,a,n,s,e)).map(A),c={},l={};o.forEach((a=>{c[a.SeriesInstanceUID]||(c[a.SeriesInstanceUID]={StudyInstanceUID:a.StudyInstanceUID,StudyDescription:a.StudyDescription,SeriesInstanceUID:a.SeriesInstanceUID,SeriesDescription:a.SeriesDescription,SeriesNumber:a.SeriesNumber,SeriesTime:a.SeriesTime,SOPClassUID:a.SOPClassUID,ProtocolName:a.ProtocolName,Modality:a.Modality}),l[a.SeriesInstanceUID]||(l[a.SeriesInstanceUID]=[]);const n=h.getImageIdsForInstance({instance:a});a.imageId=n,a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri,k.addImageIdToUIDs(n,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID}),l[a.SeriesInstanceUID].push(a)}));const u=Object.values(c);return i.DicomMetadataStore.addSeriesMetadata(u,r),Object.keys(l).forEach((e=>i.DicomMetadataStore.addInstances(l[e],r))),c},_retrieveSeriesMetadataAsync:async(t,a,n,s,r=!1,o=!1)=>{f.headers=y();const{preLoadData:c,promises:l}=await U(f,t,!0,a,n,s,e),u=t=>{const a=A(t);return e.bulkDataURI?.enabled?(Object.keys(a).forEach((t=>{const n=a[t];n&&n.BulkDataURI&&!n.Value&&(n.retrieveBulkData=(t={})=>{R(n,a,e);const{mediaType:s}=t,r={multipart:!1,BulkDataURI:n.BulkDataURI,StudyInstanceUID:a.StudyInstanceUID,mediaTypes:s?[{mediaType:s},{mediaType:"application/octet-stream"}]:void 0,...t};return I.retrieveBulkData(r).then((e=>{const t=e instanceof Array&&e.find((e=>e?.byteLength))||void 0;return n.Value=t,t}))})})),a):a};function d(){const e=i.DicomMetadataStore.getStudy(t);e&&(e.isLoaded=!0)}c.forEach((e=>{e.StudyInstanceUID=t})),i.DicomMetadataStore.addSeriesMetadata(c,r);const m=l.map((a=>(o||a?.start(),a.then((a=>{!function(a){const n=a.map(u);n.forEach((a=>{a.wadoRoot=e.wadoRoot,a.wadoUri=e.wadoUri;const n=h.getImageIdsForInstance({instance:a});a.imageId=n,k.addImageIdToUIDs(n,{StudyInstanceUID:t,SeriesInstanceUID:a.SeriesInstanceUID,SOPInstanceUID:a.SOPInstanceUID})})),i.DicomMetadataStore.addInstances(n,r)}(a)})))));return o?(Promise.all(m).then((()=>d())),l):(await Promise.all(m),d(),c)},deleteStudyMetadataPromise:M,getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance:({instance:t,frame:a})=>g({instance:t,frame:a,config:e}),getConfig:()=>s,getStudyInstanceUIDs({params:e,query:t}){const{StudyInstanceUIDs:a}=e,n=i.utils.splitComma(t.getAll("StudyInstanceUIDs")),s=n.length&&n||a;return s&&Array.isArray(s)?s:[s]}};var D;return e.supportsReject&&(h.reject=(D=e.wadoRoot,{series:(e,t)=>new Promise(((a,n)=>{const s=`${D}/studies/${e}/series/${t}/reject/113001%5EDCM`,r=new XMLHttpRequest;r.open("POST",s,!0),console.log(r),r.onreadystatechange=function(){if(4==r.readyState)switch(r.status){case 204:a(r.responseText);break;case 404:n("Your dataSource does not support reject functionality")}},r.send()}))})),i.pt.create(h)}const $=i.Ay.classes.MetadataProvider,q={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let _={urls:[],studyInstanceUIDMap:new Map};function j(e){return Object.keys(e).reduce(((t,a)=>("object"==typeof e[a]&&null!==e[a]?t[a]=j(e[a]):t[a]=e[a],a.endsWith("Sequence")&&(t[a]=i.Ay.utils.addAccessors(t[a])),t)),Array.isArray(e)?[]:{})}const B=e=>_.urls.find((t=>t.url===e)),H=(e,t)=>{let a=[];return _.urls.map((n=>{n.studies.map((n=>{n[e]===t&&a.push(n)}))})),a};function G(e){const{wadoRoot:t}=e,a={initialize:async({query:e,url:t})=>{t||(t=e.get("url"));let a=B(t);if(a)return a.studies.map((e=>e.StudyInstanceUID));const n=await fetch(t),s=await n.json();let r,i;s.studies.forEach((e=>{r=e.StudyInstanceUID,e.series.forEach((e=>{i=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;$.addImageIdToUIDs(t,{StudyInstanceUID:r,SeriesInstanceUID:i,SOPInstanceUID:a.SOPInstanceUID})}))}))})),_.urls.push({url:t,studies:[...s.studies]}),_.studyInstanceUIDMap.set(t,s.studies.map((e=>e.StudyInstanceUID)))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],n=q[t];return H(n,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.warn(" DICOMJson QUERY processResults not implemented")}},series:{search:()=>{console.warn(" DICOMJson QUERY SERIES SEARCH not implemented")}},instances:{search:()=>{console.warn(" DICOMJson QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>x(t,e),series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1,customSort:a}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=H("StudyInstanceUID",e)[0];let s;s=a?a(n.series):n.series;const r=s.map((e=>{const t={StudyInstanceUID:n.StudyInstanceUID,...e};return delete t.instances,t}));i.DicomMetadataStore.addSeriesMetadata(r,t);const o=s.length;s.forEach(((a,s)=>{const r=a.instances.map((e=>{const t={...j(e.metadata),url:e.url,imageId:e.url,...a,...n};return delete t.instances,delete t.series,t}));var c;c=r,i.DicomMetadataStore.addInstances(c,t),s===o-1&&(i.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:()=>{console.warn(" DICOMJson store dicom not implemented")}},getImageIdsForDisplaySet(t){const a=t.images,n=[];return a?(t.images.forEach((t=>{const a=t.NumberOfFrames;if(a>1)for(let s=0;s<a;s++){const a=g({instance:t,frame:s,config:e});n.push(a)}else{const a=g({instance:t,config:e});n.push(a)}})),n):n},getImageIdsForInstance:({instance:e,frame:t})=>g({instance:e,frame:t}),getStudyInstanceUIDs:({params:e,query:t})=>{const a=t.get("url");return _.studyInstanceUIDMap.get(a)}};return i.pt.create(a)}const z=i.Ay.classes.MetadataProvider,{EVENTS:W}=i.DicomMetadataStore,J={SR:!0,SEG:!0,DOC:!0},Y=(e,t,a=0)=>e===t?a:e<t?-1:1,X=(e,t)=>{const a=e.instances[0],n=t.instances[0],s=a.Modality,r=n.Modality,i=J[s],o=J[r];return i&&o?Y(a.SeriesNumber,n.SeriesNumber):i||o?i?-1:1:Y(n.SeriesNumber,a.SeriesNumber)};function K(e){const{name:t}=e,a={initialize:({params:e,query:t})=>{},query:{studies:{mapParams:()=>{},search:e=>i.DicomMetadataStore.getStudyInstanceUIDs().map((e=>{let t=0;const a=new Set,n=i.DicomMetadataStore.getStudy(e);n.series.forEach((e=>{t+=e.instances.length,a.add(e.instances[0].Modality)}));const s=n?.series[0]?.instances[0];if(s)return{accession:s.AccessionNumber,date:s.StudyDate,description:s.StudyDescription,mrn:s.PatientID,patientName:i.utils.formatPN(s.PatientName),studyInstanceUid:s.StudyInstanceUID,time:s.StudyTime,instances:t,modalities:Array.from(a).join("/"),NumInstances:t}})),processResults:()=>{console.warn(" DICOMLocal QUERY processResults not implemented")}},series:{search:e=>i.DicomMetadataStore.getStudy(e).series.map((t=>{const a=t?.instances[0];return{studyInstanceUid:e,seriesInstanceUid:a.SeriesInstanceUID,modality:a.Modality,seriesNumber:a.SeriesNumber,seriesDate:a.SeriesDate,numSeriesInstances:t.instances.length,description:a.SeriesDescription}}))},instances:{search:()=>{console.warn(" DICOMLocal QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e,s=t[a];if(s instanceof Array&&s[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([s[0]],{type:n}))},series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const a=i.DicomMetadataStore.getStudy(e,t);i.DicomMetadataStore._broadcastEvent(W.SERIES_ADDED,{StudyInstanceUID:e,madeInClient:t}),a.series.forEach((a=>{const{SeriesInstanceUID:n}=a,s=a.instances[0].NumberOfFrames>1;a.instances.forEach(((e,t)=>{const{url:a,StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i}=e;e.imageId=a,z.addImageIdToUIDs(a,{StudyInstanceUID:n,SeriesInstanceUID:r,SOPInstanceUID:i,frameIndex:s?t:1})})),i.DicomMetadataStore._broadcastEvent(W.INSTANCES_ADDED,{StudyInstanceUID:e,SeriesInstanceUID:n,madeInClient:t})}))}}},store:{dicom:e=>{const t=I.Ay.data.datasetToBlob(e);var a=URL.createObjectURL(t);window.location.assign(a)}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance({instance:e,frame:t}){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;let r=i.DicomMetadataStore.getInstance(a,n,s).url;return void 0!==t&&(r+=`&frame=${t}`),r},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")},getStudyInstanceUIDs:({params:e,query:t})=>{const{StudyInstanceUIDs:a}=e,n=t.getAll("StudyInstanceUIDs")||a,s=n&&Array.isArray(n)?n:[n];let r=!1;return s.forEach((e=>{const t=i.DicomMetadataStore.getStudy(e);t&&(t.series=t.series.sort(X),r=!0)})),r?s:[]}};return i.pt.create(a)}var Q=a(53955),Z=a.n(Q);const{getString:ee,getName:te,getModalities:ae}=i.DICOMWeb,ne="sql/statements/";function se(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>t.push({studyInstanceUid:ee(JSON.parse(e[0])),date:ee(JSON.parse(e[1])),time:ee(JSON.parse(e[2])),accession:ee(JSON.parse(e[3]))||"",mrn:ee(JSON.parse(e[4]))||"",patientName:i.utils.formatPN(te(JSON.parse(e[5])))||"",description:ee(JSON.parse(e[6]))||"",modalities:ee(ae(JSON.parse(e[7]),JSON.parse(e[8])))||"",instances:Number(JSON.parse(e[9]))||1}))),t}function re(e,t={}){if(!e)return;const a=["00081030","00080060"].join(","),{supportsWildcard:n}=t,s=e=>n&&e?`*${e}*`:e,r={PatientName:s(e.patientName),"00100020":s(e.patientId),AccessionNumber:s(e.accessionNumber),StudyDescription:s(e.studyDescription),ModalitiesInStudy:e.modalitiesInStudy,limit:e.limit||101,offset:e.offset||0,fuzzymatching:!0===t.supportsFuzzyMatching,includefield:a};if(e.startDate&&e.endDate)r.StudyDate=`${e.startDate}-${e.endDate}`;else if(e.startDate){const t=new Date,a=String(t.getDate()).padStart(2,"0"),n=String(t.getMonth()+1).padStart(2,"0"),s=`${t.getFullYear()}${n}${a}`;r.StudyDate=`${e.startDate}-${s}`}else if(e.endDate){const t="19700102";r.StudyDate=`${t}-${e.endDate}`}if(e.studyInstanceUid){let t=e.studyInstanceUid;t=Array.isArray(t)?t.join():t,t=t.replace(/[^0-9.]+/g,"\\"),r.StudyInstanceUID=t}const i={};return Object.keys(r).forEach((e=>{void 0!==r[e]&&""!==r[e]&&(i[e]=r[e])})),i}const ie=i.Ay.classes.MetadataProvider,{DicomMetaDictionary:oe,DicomDict:ce}=I.Ay.data,{naturalizeDataset:le,denaturalizeDataset:ue}=oe;function de(e,t){let a,n,s;console.info("createDatabricksPixelsDicom");const r={initialize:async({params:r,query:i})=>{if(console.info("createDatabricksPixelsDicom - Initialize"),a=JSON.parse(JSON.stringify(e)),!(a.token&&a.serverHostname&&a.httpPath&&a.pixelsTable))throw new Error("Cannot find Server Hostname, HTTP Path, or personal access token. Check the environment variables DATABRICKS_SERVER_HOSTNAME, DATABRICKS_HTTP_PATH, DATABRICKS_TOKEN and pixelsTable.");const o=a.token,c=a.serverHostname;a.httpPath;n=Z().create({baseURL:c+"/api/2.0/"}),n.defaults.headers.common.Authorization=`Bearer ${o}`;t.services.userAuthenticationService.getAuthorizationHeader=()=>({Authorization:`Bearer ${o}`}),s=a.httpPath.split("/")[4]},query:{studies:{mapParams:re.bind(),search:async function(e){console.info("createDatabricksPixelsDicom - query studies");const t=await async function(e,t,a){let n={warehouse_id:t,statement:`select *, count(*) as instances from (SELECT\n          meta:['0020000D'] as studyInstanceUid,\n          meta:['00080020'] as date,\n          meta:['00080030'] as time,\n          meta:['00080050'] as accession,\n          meta:['00100020'] as mrn,\n          meta:['00100010'] as patientName,\n          meta:['00081030'] as description,\n          meta:['00080060'] as modalities1,\n          meta:['00080061'] as modalities2\n       FROM ${a})\n       group by all`,wait_timeout:"30s",on_wait_timeout:"CANCEL"};return(await e.post(ne,n)).data.result.data_array}(n,s,a.pixelsTable);return se(t)},processResults:se.bind()},series:{search:async e=>{console.info("createDatabricksPixelsDicom - query series",e);const t=await async function(e,t,a,n){let s={warehouse_id:t,statement:`SELECT             meta:['0020000D'] as studyInstanceUid,\n            meta:['0020000E'] as seriesInstanceUid,\n            meta:['00080018'] as SOPInstanceUID,\n            meta:['00080060'] as modality,\n            meta:['00200011'] as seriesNumber,\n            meta:['00080021'] as seriesDate,\n            meta:['00201209'] as numSeriesInstances,\n            meta:['0008103E'] as description,\n            path\n       FROM ${n}\n       WHERE meta:['0020000D'].Value[0] = '${a}'`,wait_timeout:"30s",on_wait_timeout:"CANCEL"};return(await e.post(ne,s)).data.result.data_array}(n,s,e,a.pixelsTable),r=function(e){const t=[];return e&&e.length&&e.forEach((e=>t.push({studyInstanceUid:ee(JSON.parse(e[0])),seriesInstanceUid:ee(JSON.parse(e[1])),sopInstanceUID:ee(JSON.parse(e[2])),modality:ee(JSON.parse(e[3])),seriesNumber:ee(JSON.parse(e[4])),seriesDate:i.utils.formatDate(ee(JSON.parse(e[5]))),numSeriesInstances:Number(ee(JSON.parse(e[6]))),description:ee(JSON.parse(e[7])),path:e[8]}))),(0,o.LM)(t),t}(t);return r}},instances:{search:()=>{console.warn(" QUERY instances SEARCH not implemented")}}},retrieve:{directURL:e=>{const{instance:t,tag:a,defaultType:n}=e;console.log("retrieve direct url");const s=t[a];if(s instanceof Array&&s[0]instanceof ArrayBuffer)return URL.createObjectURL(new Blob([s[0]],{type:n}))},bulkDataURI:async({StudyInstanceUID:e,BulkDataURI:t})=>{console.warn(" Retrieve bulkDataURI not implemented")},series:{metadata:async({StudyInstanceUID:e,madeInClient:t=!1}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const r=await async function(e,t,a,n){let s={warehouse_id:t,statement:`\n    with qico(\n      SELECT\n            meta:['0020000D'].Value[0] as StudyInstanceUID,\n            meta:['0020000E'].Value[0] as SeriesInstanceUID,\n            meta:['00080018'].Value[0] as SOPInstanceUID,\n            meta:['00080016'].Value[0] as SOPClassUID,\n            meta,\n            relative_path\n       FROM ${n}\n    )\n\n    select StudyInstanceUID, SeriesInstanceUID, collect_list(\n      struct(SOPInstanceUID,\n            SOPClassUID,\n            meta,\n            relative_path)\n    ) from qico\n       WHERE studyInstanceUid = '${a}'\n       group by studyInstanceUid, seriesInstanceUid`,wait_timeout:"30s",on_wait_timeout:"CANCEL"};return(await e.post(ne,s)).data.result.data_array}(n,s,e,a.pixelsTable),o=function(e){if(!e||!e.length)return[];const t=[];return e.forEach((e=>{var a={StudyInstanceUid:e[0],SeriesInstanceUid:e[1],instances:JSON.parse(e[2])};a.instances.forEach(((e,t)=>{e.StudyInstanceUID=a.StudyInstanceUid,e.SeriesInstanceUID=a.SeriesInstanceUid,e.InstanceNumber=t,e.numImageFrames=a.instances.length,e.meta=JSON.parse(e.meta.replaceAll("'",'"'))})),t.push(a)})),t}(r),c={},l={};o.forEach((e=>{e.instances.forEach(((e,t)=>{const a=le(e.meta);a.url="dicomweb:"+n.defaults.baseURL+"fs/files/"+e.relative_path;const{url:s,StudyInstanceUID:r,SeriesInstanceUID:i,SOPInstanceUID:o}=a;a.imageId=s,c[a.SeriesInstanceUID]||(c[a.SeriesInstanceUID]={StudyInstanceUID:a.StudyInstanceUID,StudyDescription:a.studyDescription,SeriesInstanceUID:a.SeriesInstanceUID,SeriesDescription:a.seriesDescription,SOPInstanceUID:a.SOPInstanceUID,SeriesNumber:a.seriesNumber,SeriesTime:a.seriesTime,SOPClassUID:a.sopClassUID,ProtocolName:a.protocolName,Modality:a.modality}),l[a.SeriesInstanceUID]||(l[a.SeriesInstanceUID]=[]),ie.addImageIdToUIDs(s,{StudyInstanceUID:r,SeriesInstanceUID:i,SOPInstanceUID:o,frameIndex:1}),l[a.SeriesInstanceUID].push(a)}));const a=Object.values(c);i.DicomMetadataStore.addSeriesMetadata(a,t),Object.keys(l).forEach((e=>i.DicomMetadataStore.addInstances(l[e],t)))}))}}},store:{dicom:async(e,t,a)=>{console.warn(" store dicom not implemented")}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=1;n<=t;n++){const t=this.getImageIdsForInstance({instance:e,frame:n});a.push(t)}else{const t=this.getImageIdsForInstance({instance:e});a.push(t)}})),a):a},getImageIdsForInstance({instance:e,frame:t}){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;let r=i.DicomMetadataStore.getInstance(a,n,s).url;return void 0!==t&&(r+=`&frame=${t}`),r},deleteStudyMetadataPromise(){console.log("deleteStudyMetadataPromise not implemented")},getStudyInstanceUIDs:({params:e,query:t})=>{console.log("getStudyInstanceUIDs");const{StudyInstanceUIDs:a}=e,n=i.utils.splitComma(t.getAll("StudyInstanceUIDs")),s=n.length&&n||a;return s&&Array.isArray(s)?s:[s]}};return i.pt.create(r)}function me(e,t){const{name:a}=e;let n;const s={initialize:async({params:e,query:s})=>{const r=s.get("url");if(!r)throw new Error(`No url for '${a}'`);{const a=await fetch(r);let i=await a.json();if(!i.servers?.dicomWeb?.[0])throw new Error("Invalid configuration returned by url");n=V(i.servers.dicomWeb[0].configuration,t),n.initialize({params:e,query:s})}},query:{studies:{search:e=>n.query.studies.search(e)},series:{search:(...e)=>n.query.series.search(...e)},instances:{search:(e,t)=>n.query.instances.search(e,t)}},retrieve:{directURL:(...e)=>n.retrieve.directURL(...e),series:{metadata:async(...e)=>n.retrieve.series.metadata(...e)}},store:{dicom:(...e)=>n.store(...e)},deleteStudyMetadataPromise:(...e)=>n.deleteStudyMetadataPromise(...e),getImageIdsForDisplaySet:(...e)=>n.getImageIdsForDisplaySet(...e),getImageIdsForInstance:(...e)=>n.getImageIdsForInstance(...e),getStudyInstanceUIDs({params:e,query:t}){let n=[];const s=t.get("studyInstanceUIDs")||t.get("studyInstanceUids");if(!s)throw new Error(`No studyInstanceUids in request for '${a}'`);return n=s.split(";"),n}};return i.pt.create(s)}var pe=a(5517);const ge={"query.studies.search":{mergeKey:"studyInstanceUid",tagFunc:e=>e},"query.series.search":{mergeKey:"seriesInstanceUid",tagFunc:(e,t)=>(e.forEach((e=>{e.RetrieveAETitle=t,i.DicomMetadataStore.updateSeriesMetadata(e)})),e)}},Ie=async({mergeMap:e,path:t,args:a,extensionManager:n,dataSourceNames:s,defaultDataSourceName:r})=>{const{mergeKey:i,tagFunc:o}=e[t]||{tagFunc:e=>e},c=Object.values(n.dataSourceDefs),l=c.find((e=>e.sourceName===r)),u=c.filter((e=>e.sourceName!==r));l&&u.unshift(l);const d=[],m=[];for(const e of u){const{configuration:r,sourceName:i}=e;if(r&&s.includes(i)){const[e]=n.getDataSources(i),s=(0,pe.get)(e,t).apply(e,a);d.push(s),m.push(i)}}const p=(await Promise.allSettled(d)).map(((e,t)=>o(e.value,m[t])));let g=[];return g=i?(0,pe.uniqBy)(p.flat(),(e=>(0,pe.get)(e,i))):p.flat(),g},fe=({path:e,args:t,extensionManager:a,dataSourceNames:n,defaultDataSourceName:s})=>{const r=Object.values(a.dataSourceDefs),i=r.find((e=>e.sourceName===s)),o=r.filter((e=>e.sourceName!==s));i&&o.unshift(i);const c=[];for(const s of o){const{configuration:r,sourceName:i}=s;if(r&&n.includes(i)){const[n]=a.getDataSources(i),s=(0,pe.get)(n,e).apply(n,t);c.push(s)}}return c.flat()},Se=({path:e,args:t,defaultDataSourceName:a,extensionManager:n})=>{const[s]=n.getDataSources(a);return(0,pe.get)(s,e).apply(s,t)},ye=({path:e,args:t,defaultDataSourceName:a,extensionManager:n})=>{const[s]=t,r=i.DicomMetadataStore.getSeries(s.StudyInstanceUID,s.SeriesInstanceUID),[o]=n.getDataSources(r.RetrieveAETitle||a);return o[e](...t)};function he(e,t,a){const{seriesMerge:n}=e,{dataSourceNames:s,defaultDataSourceName:r}=n,o={initialize:(...e)=>fe({path:"initialize",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),query:{studies:{search:(...e)=>Ie({mergeMap:ge,path:"query.studies.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})},series:{search:(...e)=>Ie({mergeMap:ge,path:"query.series.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})},instances:{search:(...e)=>Ie({mergeMap:ge,path:"query.instances.search",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})}},retrieve:{bulkDataURI:(...e)=>Ie({mergeMap:ge,path:"retrieve.bulkDataURI",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),directURL:(...e)=>Se({path:"retrieve.directURL",args:e,defaultDataSourceName:r,extensionManager:a}),series:{metadata:(...e)=>Ie({mergeMap:ge,path:"retrieve.series.metadata",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})}},store:{dicom:(...e)=>Se({path:"store.dicom",args:e,defaultDataSourceName:r,extensionManager:a})},deleteStudyMetadataPromise:(...e)=>fe({path:"deleteStudyMetadataPromise",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r}),getImageIdsForDisplaySet:(...e)=>ye({path:"getImageIdsForDisplaySet",args:e,defaultDataSourceName:r,extensionManager:a}),getImageIdsForInstance:(...e)=>ye({path:"getImageIdsForDisplaySet",args:e,defaultDataSourceName:r,extensionManager:a}),getStudyInstanceUIDs:(...e)=>fe({path:"getStudyInstanceUIDs",args:e,extensionManager:a,dataSourceNames:s,defaultDataSourceName:r})};return i.pt.create(o)}const De=function(){return[{name:"dicomweb",type:"webApi",createDataSource:V},{name:"dicomwebproxy",type:"webApi",createDataSource:me},{name:"dicomjson",type:"jsonApi",createDataSource:G},{name:"dicomlocal",type:"localApi",createDataSource:K},{name:"databricksPixelsDicom",type:"webApi",createDataSource:de},{name:"merge",type:"mergeApi",createDataSource:he}]};var ve=a(41766),be=a(11374),we=a.n(be),Ee=a(21683),Ue=a(15575),Me=a(37396),Ne=a(80619),xe=a(10971),Re=a(69536),Ce=a(61466),Pe=a.n(Ce);function Ae(){return Ae=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Ae.apply(this,arguments)}function Oe({servicesManager:e}){const{toolbarService:t}=e.services,[a,n]=(0,Ee.ih)(),[s,r]=(0,ve.useState)([]);(0,ve.useEffect)((()=>{const e=()=>{const e=n.getActiveViewportOptionByKey("toolGroupId")??"default";r(t.getButtonSection(e))},{unsubscribe:a}=t.subscribe(t.EVENTS.TOOL_BAR_MODIFIED,e);return e(),()=>{a()}}),[t,a]);const i=(0,ve.useCallback)((e=>t.recordInteraction(e)),[t]);return ve.createElement(ve.Fragment,null,s.map((t=>{const{id:a,Component:n,componentProps:s}=t;return ve.createElement("div",{key:a,className:Pe()("mr-1")},ve.createElement(n,Ae({id:a},s,{onInteraction:i,servicesManager:e})))})))}const{availableLanguages:Te,defaultLanguage:Fe,currentLanguage:Le}=Re.A;const ke=function({hotkeysManager:e,extensionManager:t,servicesManager:a}){const[n]=(0,Ue.r)(),s=(0,Me.Zp)(),r=(0,xe.zy)(),{t:o}=(0,Ne.Bd)(),{show:c,hide:l}=(0,Ee.hS)(),{hotkeyDefinitions:u,hotkeyDefaults:d}=e,m=[{title:o("Header:About"),icon:"info",onClick:()=>c({content:Ee.VT,title:o("AboutModal:About OHIF Viewer"),contentProps:{versionNumber:"3.8.0-beta.60",commitHash:"f7fe91c5f6c4f05f3f3f5f640d3a119bd40a5870"}})},{title:o("Header:Preferences"),icon:"settings",onClick:()=>c({title:o("UserPreferencesModal:User preferences"),content:Ee.im,contentProps:{hotkeyDefaults:e.getValidHotkeyDefinitions(d),hotkeyDefinitions:u,currentLanguage:Le(),availableLanguages:Te,defaultLanguage:Fe,onCancel:()=>{i.ot.stopRecord(),i.ot.unpause(),l()},onSubmit:({hotkeyDefinitions:t,language:a})=>{a.value!==Le().value&&Re.A.changeLanguage(a.value),e.setHotkeys(t),l()},onReset:()=>e.restoreDefaultBindings(),hotkeysModule:i.ot}})}];return n.oidc&&m.push({title:o("Header:Logout"),icon:"power-off",onClick:async()=>{s(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`)}}),ve.createElement(Ee.Y9,{menuOptions:m,isReturnEnabled:!!n.showStudyList,onClickReturnButton:()=>{const{pathname:e}=r,a=e.indexOf("/",1),n=new URLSearchParams(window.location.search).get("configUrl"),i=e.substring(a+1),o=t.getDataSources(i),c=new URLSearchParams;-1!==a&&o&&c.append("datasources",e.substring(a+1)),n&&c.append("configUrl",n),s({pathname:"/",search:decodeURIComponent(c.toString())})},WhiteLabeling:n.whiteLabeling},ve.createElement(Ee.tH,{context:"Primary Toolbar"},ve.createElement("div",{className:"relative flex justify-center"},ve.createElement(Oe,{servicesManager:a}))))},Ve=({servicesManager:e,side:t,className:a,activeTabIndex:n,tabs:s,expandedWidth:r})=>{const i=e?.services?.panelService,[o,c]=(0,ve.useState)(!1),[l,u]=(0,ve.useState)(n);return(0,ve.useEffect)((()=>{if(i){const e=i.subscribe(i.EVENTS.ACTIVATE_PANEL,(e=>{if(!o||e.forceActive){const t=s.findIndex((t=>t.id===e.panelId));-1!==t&&u(t)}}));return()=>{e.unsubscribe()}}}),[s,o,i]),ve.createElement(Ee.wv,{side:t,className:a,activeTabIndex:l,tabs:s,onOpen:()=>{c(!0)},expandedWidth:r})};function $e({extensionManager:e,servicesManager:t,hotkeysManager:a,commandsManager:n,viewports:s,ViewportGridComp:r,leftPanels:o=[],rightPanels:c=[],leftPanelDefaultClosed:l=!1,rightPanelDefaultClosed:u=!1}){const[d]=(0,Ue.r)(),{hangingProtocolService:m}=t.services,[p,g]=(0,ve.useState)(d.showLoadingIndicator);(0,ve.useEffect)((()=>(document.body.classList.add("bg-black"),document.body.classList.add("overflow-hidden"),()=>{document.body.classList.remove("bg-black"),document.body.classList.remove("overflow-hidden")})),[]);const I=t=>{const a=e.getModuleEntry(t);if(!a)throw new Error(`${t} is not valid for an extension module. Please verify your configuration or ensure that the extension is properly registered. It's also possible that your mode is utilizing a module from an extension that hasn't been included in its dependencies (add the extension to the "extensionDependencies" array in your mode's index.js file)`);let n;if(!a||!a.component)throw new Error(`No component found from extension ${t}. Check the reference string to the extension in your Mode configuration`);return n=a.component,{entry:a,content:n}},f=e=>{const{content:t,entry:a}=I(e);return{id:a.id,iconName:a.iconName,iconLabel:a.iconLabel,label:a.label,name:a.name,content:t}};(0,ve.useEffect)((()=>{const{unsubscribe:e}=m.subscribe(i.Qe.EVENTS.PROTOCOL_CHANGED,(()=>{g(!1)}));return()=>{e()}}),[m]);const S=o.map(f),y=c.map(f),h=s.map((e=>{const{entry:t}=I(e.namespace);return{component:t.component,displaySetsToDisplay:e.displaySetsToDisplay}}));return ve.createElement("div",null,ve.createElement(ke,{hotkeysManager:a,extensionManager:e,servicesManager:t}),ve.createElement("div",{className:"relative flex w-full flex-row flex-nowrap items-stretch overflow-hidden bg-black",style:{height:"calc(100vh - 52px"}},ve.createElement(ve.Fragment,null,p&&ve.createElement(Ee.Jx,{className:"h-full w-full bg-black"}),S.length?ve.createElement(Ee.tH,{context:"Left Panel"},ve.createElement(Ve,{side:"left",activeTabIndex:l?null:0,tabs:S,servicesManager:t})):null,ve.createElement("div",{className:"flex h-full flex-1 flex-col"},ve.createElement("div",{className:"relative flex h-full flex-1 items-center justify-center overflow-hidden bg-black"},ve.createElement(Ee.tH,{context:"Grid"},ve.createElement(r,{servicesManager:t,viewportComponents:h,commandsManager:n})))),y.length?ve.createElement(Ee.tH,{context:"Right Panel"},ve.createElement(Ve,{side:"right",activeTabIndex:u?null:0,tabs:y,servicesManager:t})):null)))}$e.propTypes={extensionManager:we().shape({getModuleEntry:we().func.isRequired}).isRequired,commandsManager:we().instanceOf(i.Sp),servicesManager:we().instanceOf(i.CS),leftPanels:we().array,rightPanels:we().array,leftPanelDefaultClosed:we().bool.isRequired,rightPanelDefaultClosed:we().bool.isRequired,children:we().oneOfType([we().node,we().func]).isRequired,viewports:we().array};const qe=$e;const{sortStudyInstances:_e,formatDate:je}=i.utils;function Be({servicesManager:e,getImageSrc:t,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:n,dataSource:s}){const{hangingProtocolService:r,displaySetService:i,uiNotificationService:o}=e.services,c=(0,Me.Zp)(),{StudyInstanceUIDs:l}=(0,Ee.Bz)(),[{activeViewportId:u,viewports:d},m]=(0,Ee.ih)(),[p,g]=(0,ve.useState)("primary"),[I,f]=(0,ve.useState)([...l]),[S,y]=(0,ve.useState)([]),[h,D]=(0,ve.useState)([]),[v,b]=(0,ve.useState)({});(0,ve.useEffect)((()=>{l.forEach((e=>async function(e){const t=await s.query.studies.search({studyInstanceUid:e});if(!t?.length)throw c("/notfoundstudy","_self"),new Error("Invalid study URL");let n=t;try{n=await a(t)}catch(e){console.warn(e)}const r=n.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:je(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));y((e=>{const t=[...e];for(const a of r)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[l,s,a,c]),(0,ve.useEffect)((()=>{i.activeDisplaySets.forEach((async e=>{const a={},n=i.getDisplaySetByUID(e.displaySetInstanceUID),r=s.getImageIdsForDisplaySet(n),o=r[Math.floor(r.length/2)];o&&!n?.unsupported&&(a[e.displaySetInstanceUID]=await t(o),b((e=>({...e,...a}))))}))}),[l,s,i,t]),(0,ve.useEffect)((()=>{const e=Ge(i.activeDisplaySets,v);_e(e),D(e)}),[l,v,i]),(0,ve.useEffect)((()=>{const e=i.subscribe(i.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a,options:n}=e;a.forEach((async e=>{const a={},n=i.getDisplaySetByUID(e.displaySetInstanceUID);if(n?.unsupported)return;const r=s.getImageIdsForDisplaySet(n),o=r[Math.floor(r.length/2)];o&&(a[e.displaySetInstanceUID]=await t(o,e.initialViewport),b((e=>({...e,...a}))))}))}));return()=>{e.unsubscribe()}}),[t,s,i]),(0,ve.useEffect)((()=>{const e=i.subscribe(i.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=Ge(e,v);D(t)})),t=i.subscribe(i.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(()=>{const e=Ge(i.getActiveDisplaySets(),v);D(e)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[l,v,i]);const w=function(e,t,a){const n=[],s=[],r=[];t.forEach((t=>{const i=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),o=Object.assign({},t,{displaySets:i});e.includes(t.studyInstanceUid)?n.push(o):(s.push(o),r.push(o))}));const i=[{name:"primary",label:"Primary",studies:n},{name:"recent",label:"Recent",studies:s},{name:"all",label:"All",studies:r}];return i}(l,S,h);const E=d.get(u)?.displaySetInstanceUIDs;return ve.createElement(Ee.M4,{tabs:w,servicesManager:e,activeTabName:p,onDoubleClickThumbnail:e=>{let t=[];const a=u;try{t=r.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),o.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}m.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:E,expandedStudyInstanceUIDs:I,onClickStudy:function(e){const t=I.includes(e),a=t?[...I.filter((t=>t!==e))]:[...I,e];if(f(a),!t){n(i,e,!0)}},onClickTab:e=>{g(e)}})}Be.propTypes={servicesManager:we().object.isRequired,dataSource:we().shape({getImageIdsForDisplaySet:we().func.isRequired}).isRequired,getImageSrc:we().func.isRequired,getStudiesForPatientByMRN:we().func.isRequired,requestDisplaySetCreationForStudy:we().func.isRequired};const He=Be;function Ge(e,t){const a=[],n=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const s=t[e.displaySetInstanceUID],r=function(e){if(ze.includes(e.Modality)||e?.unsupported)return"thumbnailNoImage";return"thumbnail"}(e);("thumbnail"===r?a:n).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,messages:e.messages,componentType:r,imageSrc:s,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID},isHydratedForDerivedDisplaySet:e.isHydrated})})),[...a,...n]}const ze=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const We=function(e,t){return new Promise(((a,n)=>{const s=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:s,imageId:t}).then((e=>{a(s.toDataURL())})).catch(n)}))};const Je=async function(e,t){return t&&t.length&&t[0].mrn?e.query.studies.search({patientId:t[0].mrn}):(console.log("No mrn found for",t),t)};const Ye=function(e,t,a,n){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};function Xe({commandsManager:e,extensionManager:t,servicesManager:a}){const n=t.getDataSources()[0],s=Je.bind(null,n),r=(0,ve.useCallback)(function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return We.bind(null,e)}catch(e){throw new Error("Required command not found")}}(t),[]),i=Ye.bind(null,n);return ve.createElement(He,{servicesManager:a,dataSource:n,getImageSrc:r,getStudiesForPatientByMRN:s,requestDisplaySetCreationForStudy:i})}Xe.propTypes={commandsManager:we().object.isRequired,extensionManager:we().object.isRequired,servicesManager:we().object.isRequired};const Ke=Xe;function Qe({onExportClick:e,onCreateReportClick:t}){const{t:a}=(0,Ne.Bd)("MeasurementTable");return ve.createElement(ve.Fragment,null,ve.createElement(Ee.xA,{color:"black",size:"inherit"},ve.createElement(Ee._H,{className:"px-2 py-2 text-base",onClick:e},a("Export CSV")),ve.createElement(Ee._H,{className:"px-2 py-2 text-base",onClick:t},a("Create Report"))))}Qe.propTypes={onExportClick:we().func,onCreateReportClick:we().func},Qe.defaultProps={onExportClick:()=>alert("Export"),onCreateReportClick:()=>alert("Create Report")};const Ze=Qe;var et=a(14771),tt=a.n(et);const at={CANCEL:0,CREATE_REPORT:1};function nt(e,{extensionManager:t}){return new Promise((function(a,n){let s;const r=Object.keys(t.dataSourceMap).filter((e=>{const a=t.dataSourceDefs[e]?.configuration;return a?.supportsStow??a?.wadoRoot})).map((e=>({value:e,label:e,placeHolder:e})));s=e.create({centralize:!0,isDraggable:!1,content:Ee.lG,useLastPosition:!1,showOverlay:!0,contentProps:{title:"Create Report",value:{label:"",dataSourceName:t.activeDataSource},noCloseButton:!0,onClose:()=>{e.dismiss({id:s}),a({action:at.CANCEL,value:void 0,dataSourceName:void 0})},actions:[{id:"cancel",text:"Cancel",type:Ee.Ny.NW.secondary},{id:"save",text:"Save",type:Ee.Ny.NW.primary}],onSubmit:({action:t,value:n})=>{switch(e.dismiss({id:s}),t.id){case"save":a({action:at.CREATE_REPORT,value:n.label,dataSourceName:n.dataSourceName});break;case"cancel":a({action:at.CANCEL,value:void 0,dataSourceName:void 0})}},body:({value:t,setValue:n})=>ve.createElement(ve.Fragment,null,r.length>1&&window.config?.allowMultiSelectExport&&ve.createElement("div",null,ve.createElement("label",{className:"text-[14px] leading-[1.2] text-white"},"Data Source"),ve.createElement(Ee.l6,{closeMenuOnSelect:!0,className:"border-primary-main  mt-2 bg-black",options:r,placeholder:r.find((e=>e.value===t.dataSourceName)).placeHolder,value:t.dataSourceName,onChange:e=>{n((t=>({...t,dataSourceName:e.value})))},isClearable:!1})),ve.createElement("div",{className:"mt-3"},ve.createElement(Ee.pd,{autoFocus:!0,label:"Enter the report name",labelClassName:"text-white text-[14px] leading-[1.2]",className:"border-primary-main bg-black",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:n=>{"Enter"===n.key&&(e.dismiss({id:s}),a({action:at.CREATE_REPORT,value:t.label}))},required:!0})))}})}))}function st(){return ve.createElement("div",{className:"text-primary-active"},"Loading...")}const rt=async function({servicesManager:e,getReport:t,reportType:a="measurement"}){const{displaySetService:n,uiNotificationService:s,uiDialogService:r}=e.services,o=r.create({showOverlay:!0,isDraggable:!1,centralize:!0,content:st});try{const e=await t();i.DicomMetadataStore.addInstances([e],!0);const r=n.getMostRecentDisplaySet().displaySetInstanceUID;return s.show({title:"Create Report",message:`${a} saved successfully`,type:"success"}),[r]}catch(e){s.show({title:"Create Report",message:e.message||`Failed to store ${a}`,type:"error"})}finally{r.dismiss({id:o})}},it=4700;function ot(e,t){const a=t.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).find((t=>t.SeriesDescription===e));if(a){console.log("Storing to same series",a);const{instance:e}=a,{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:r,SeriesNumber:i,Modality:o}=e;return{SeriesInstanceUID:t,SeriesDescription:n,SeriesDate:s,SeriesTime:r,SeriesNumber:i,Modality:o,InstanceNumber:a.instances.length+1}}const n=function(e){const t=e.getActiveDisplaySets().filter((e=>"SR"===e.Modality)).map((e=>e.SeriesNumber));return Math.max(...t,it)+1}(t);return{SeriesDescription:e,SeriesNumber:n}}const{downloadCSVReport:ct}=i.utils;function lt({servicesManager:e,commandsManager:t,extensionManager:a}){const{t:n}=(0,Ne.Bd)("MeasurementTable"),[s,r]=(0,Ee.ih)(),{activeViewportId:i,viewports:o}=s,{measurementService:c,uiDialogService:l,uiNotificationService:u,displaySetService:d}=e.services,[m,p]=(0,ve.useState)([]);(0,ve.useEffect)((()=>{const e=tt()(p,100);p(ut(c));const t=c.EVENTS.MEASUREMENT_ADDED,a=c.EVENTS.RAW_MEASUREMENT_ADDED,n=c.EVENTS.MEASUREMENT_UPDATED,s=c.EVENTS.MEASUREMENT_REMOVED,r=c.EVENTS.MEASUREMENTS_CLEARED,i=[];return[t,a,n,s,r].forEach((t=>{i.push(c.subscribe(t,(()=>{e(ut(c))})).unsubscribe)})),()=>{i.forEach((e=>{e()})),e.cancel()}}),[]);const g=({uid:e,isActive:t})=>{if(!t){const t=[...m],a=t.find((t=>t.uid===e));t.forEach((t=>t.isActive=t.uid===e)),a.isActive=!0,p(t)}};return ve.createElement(ve.Fragment,null,ve.createElement("div",{className:"ohif-scrollbar overflow-y-auto overflow-x-hidden","data-cy":"measurements-panel"},ve.createElement(Ee.V,{title:n("Measurements"),servicesManager:e,data:m,onClick:({uid:e,isActive:t})=>{c.jumpToMeasurement(s.activeViewportId,e),g({uid:e,isActive:t})},onEdit:({uid:e,isActive:t})=>{const a=c.getMeasurement(e),n=({action:t,value:n})=>{if("save"===t.id)c.update(e,{...a,...n},!0);l.dismiss({id:"enter-annotation"})};l.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:Ee.lG,contentProps:{title:"Annotation",noCloseButton:!0,value:{label:a.label||""},body:({value:e,setValue:t})=>ve.createElement(Ee.pd,{label:"Enter your annotation",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,id:"annotation",className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&n({value:e,action:{id:"save"}})}}),actions:[{id:"cancel",text:"Cancel",type:Ee.Ny.NW.secondary},{id:"save",text:"Save",type:Ee.Ny.NW.primary}],onSubmit:n}})}})),ve.createElement("div",{className:"flex justify-center p-4"},ve.createElement(Ze,{onExportClick:async function(){const e=c.getMeasurements();ct(e,c)},onClearMeasurementsClick:async function(){c.clearMeasurements()},onCreateReportClick:async function(){const n=o.get(i),s=c.getMeasurements(),r=d.getDisplaySetByUID(n.displaySetInstanceUIDs[0]),m=s.filter((e=>r.StudyInstanceUID===e.referenceStudyUID));if(m.length<=0)return void u.show({title:"No Measurements",message:"No Measurements are added to the current Study.",type:"info",duration:3e3});const p=await nt(l,{extensionManager:a});if(p.action===at.CREATE_REPORT){const n=a.getDataSources(p.dataSourceName)[0],s=ot(void 0===p.value||""===p.value?"Research Derived Series":p.value,d);return rt({servicesManager:e,getReport:async()=>t.runCommand("storeMeasurements",{measurementData:m,dataSource:n,additionalFindingTypes:["ArrowAnnotate"],options:s},"CORNERSTONE_STRUCTURED_REPORT")})}}})))}function ut(e){return e.getMeasurements().map(((t,a)=>function(e,t,a){const{displayText:n,uid:s,label:r,type:i,selected:o,findingSites:c,finding:l}=e,u=c?.[0],d=r||l?.text||u?.text||"(empty)";let m=n||[];if(c){const e=[];c.forEach((t=>{t?.text!==d&&e.push(t.text)})),m=[...e,...m]}l&&l?.text!==d&&(m=[l.text,...m]);return{uid:s,label:d,baseLabel:r,measurementType:i,displayText:m,baseDisplayText:n,isActive:o,finding:l,findingSites:c}}(t,0,e.VALUE_TYPES)))}lt.propTypes={servicesManager:we().instanceOf(i.CS).isRequired};var dt=a(92344);const mt=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"seriesList",iconName:"tab-studies",iconLabel:"Studies",label:dt.A.t("SidePanel:Studies"),component:Ke.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"measure",iconName:"tab-linear",iconLabel:"Measure",label:dt.A.t("SidePanel:Measurements"),secondaryLabel:dt.A.t("SidePanel:Measurements"),component:()=>ve.createElement(lt,{commandsManager:e,servicesManager:a,extensionManager:t})}]};var pt=a(8094),gt=a(48085),It=a(14169),ft=a(13835);const St=JSON.parse('{"UU":"@ohif/extension-default"}').UU;var yt=a(44563);var ht=a(58099);var Dt=a(83636);function vt(e,t,a,n){const s=Dt.eR.scaleAndAdd(Dt.eR.create(),e,a,n);return Dt.eR.distance(t,s)>n}function bt(e){if(!e?.length)return!1;const t=(0,ht.A)(e[0].ImageOrientationPatient);if(!t)return!1;const a=function(e){const t=Dt.eR.fromValues(e[0],e[1],e[2]),a=Dt.eR.fromValues(e[3],e[4],e[5]);return Dt.eR.cross(Dt.eR.create(),t,a)}(t),n=(0,ht.A)(e[0].ImagePositionPatient),s=(0,ht.A)(e[e.length-1].ImagePositionPatient),r=(0,ft.jj)(n,s)/(e.length-1);let i=n;for(let t=1;t<e.length;t++){const n=e[t],s=(0,ht.A)(n.ImagePositionPatient);if(vt(i,s,a,r))return!1;i=s}return!0}function wt(e,t){e.length>2&&(function(e){if(!e?.length)return!1;const t=e[0],a=(0,ht.A)(t.Rows),n=(0,ht.A)(t.Columns);for(let t=1;t<e.length;t++){const s=e[t],{Rows:r,Columns:i}=s;if(r!==a||i!==n)return!1}return!0}(e)||t.addMessage(i.Ob.CODES.INCONSISTENT_DIMENSIONS),function(e){if(!e?.length)return!1;const t=e[0],a=(0,ht.A)(t.SamplesPerPixel);for(let t=1;t<e.length;t++){const n=e[t],{SamplesPerPixel:s}=n;if(s!==a)return!1}return!0}(e)||t.addMessage(i.Ob.CODES.INCONSISTENT_COMPONENTS),function(e){if(!e?.length)return!1;const t=e[0],a=(0,ht.A)(t.ImageOrientationPatient);for(let t=1;t<e.length;t++){const n=e[t],s=(0,ht.A)(n.ImageOrientationPatient);if(!(0,ft.sW)(s,a))return!1}return!0}(e)||t.addMessage(i.Ob.CODES.INCONSISTENT_ORIENTATIONS),bt(e)||t.addMessage(i.Ob.CODES.INCONSISTENT_POSITION_INFORMATION),function(e,t){if(!e?.length)return;const a=(0,ht.A)(e[0].ImagePositionPatient);if(!a)return;const n=(0,ht.A)(e[e.length-1].ImagePositionPatient),s=(0,ft.jj)(a,n)/(e.length-1);let r=a;const o=[];for(let a=1;a<e.length;a++){const n=e[a],c=(0,ht.A)(n.ImagePositionPatient),l=(0,ft.jj)(c,r),u=(0,ft.Op)(l,s);if(u){const e=u.issue;if(o.includes(e)||(o.push(e),e===ft.JG.MISSING_FRAMES?t.addMessage(i.Ob.CODES.MISSING_FRAMES):e===ft.JG.IRREGULAR_SPACING&&t.addMessage(i.Ob.CODES.IRREGULAR_SPACING)),o.length>1)break}r=c}}(e,t))}function Et(e,t){const a=new i.WZ;if(!e.length)return void a.addMessage(i.Ob.CODES.NO_VALID_INSTANCES);const n=e[0],{Modality:s,ImageType:r,NumberOfFrames:o}=n;if(r?.includes("LOCALIZER"))return a;if(!ft.Hf.includes(s))return a;const c=o>1;c||e.every((e=>e.ImagePositionPatient))||a.addMessage(i.Ob.CODES.NO_POSITION_INFORMATION);const l=(0,yt.A)(e);return c?function(e,t){(0,ft.Yt)(e)||t.addMessage(i.Ob.CODES.MULTIFRAME_NO_PIXEL_MEASUREMENTS),(0,ft.VX)(e)||t.addMessage(i.Ob.CODES.MULTIFRAME_NO_ORIENTATION),(0,ft.sL)(e)||t.addMessage(i.Ob.CODES.MULTIFRAME_NO_POSITION_INFORMATION)}(l[0],a):wt(l,a),t||a.addMessage(i.Ob.CODES.NOT_RECONSTRUCTABLE),a}function Ut(e){const t=new It.A(e),a=new i.WZ;a.addMessage(i.Ob.CODES.UNSUPPORTED_DISPLAYSET);const n=e[0];return t.setAttributes({displaySetInstanceUID:t.uid,SeriesDate:n.SeriesDate,SeriesTime:n.SeriesTime,SeriesInstanceUID:n.SeriesInstanceUID,StudyInstanceUID:n.StudyInstanceUID,SeriesNumber:n.SeriesNumber||0,FrameRate:n.FrameTime,SOPClassUID:n.SOPClassUID,SeriesDescription:n.SeriesDescription||"",Modality:n.Modality,numImageFrames:e.length,unsupported:!0,SOPClassHandlerId:"unsupported",isReconstructable:!1,messages:a}),[t]}const Mt="stack",Nt=e=>e.NumberOfFrames>1,xt=e=>{const t=e[0],a=new It.A(e),{value:n,averageSpacingBetweenFrames:s}=(0,ft.Ay)(e),r=Et(e,n);a.setAttributes({displaySetInstanceUID:a.uid,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,SeriesNumber:t.SeriesNumber||0,FrameRate:t.FrameTime,SOPClassUID:t.SOPClassUID,SeriesDescription:t.SeriesDescription||"",Modality:t.Modality,isMultiFrame:Nt(t),countIcon:n?"icon-mpr":void 0,numImageFrames:e.length,SOPClassHandlerId:`${St}.sopClassHandlerModule.${Mt}`,isReconstructable:n,messages:r,averageSpacingBetweenFrames:s||null});return a.sortBy(((e,t)=>(parseInt(e.InstanceNumber)||0)-(parseInt(t.InstanceNumber)||0))),a},Rt=e=>"CR"===e||"MG"===e||"DX"===e;function Ct(e){if(!e||!e.length)throw new Error("No instances were provided");const t=[],a=function(e){const t=new Set;return e.forEach((e=>{t.add(e.SOPClassUID)})),Array.from(t)}(e),n=[];if(e.forEach((e=>{if(!(0,pt.w)(e.SOPClassUID)&&!e.Rows)return;let s;Nt(e)?(s=xt([e]),s.setAttributes({sopClassUids:a,isClip:!0,numImageFrames:e.NumberOfFrames,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):Rt(e.Modality)?(s=xt([e]),s.setAttributes({sopClassUids:a,instanceNumber:e.InstanceNumber,acquisitionDatetime:e.AcquisitionDateTime}),t.push(s)):n.push(e)})),n.length){const s=xt(n);s.setAttribute("studyInstanceUid",e[0].StudyInstanceUID),s.setAttributes({sopClassUids:a}),t.push(s)}return t}const Pt=[gt.A.ComputedRadiographyImageStorage,gt.A.DigitalXRayImageStorageForPresentation,gt.A.DigitalXRayImageStorageForProcessing,gt.A.DigitalMammographyXRayImageStorageForPresentation,gt.A.DigitalMammographyXRayImageStorageForProcessing,gt.A.DigitalIntraOralXRayImageStorageForPresentation,gt.A.DigitalIntraOralXRayImageStorageForProcessing,gt.A.CTImageStorage,gt.A.EnhancedCTImageStorage,gt.A.LegacyConvertedEnhancedCTImageStorage,gt.A.UltrasoundMultiframeImageStorage,gt.A.MRImageStorage,gt.A.EnhancedMRImageStorage,gt.A.EnhancedMRColorImageStorage,gt.A.LegacyConvertedEnhancedMRImageStorage,gt.A.UltrasoundImageStorage,gt.A.UltrasoundImageStorageRET,gt.A.SecondaryCaptureImageStorage,gt.A.MultiframeSingleBitSecondaryCaptureImageStorage,gt.A.MultiframeGrayscaleByteSecondaryCaptureImageStorage,gt.A.MultiframeGrayscaleWordSecondaryCaptureImageStorage,gt.A.MultiframeTrueColorSecondaryCaptureImageStorage,gt.A.XRayAngiographicImageStorage,gt.A.EnhancedXAImageStorage,gt.A.XRayRadiofluoroscopicImageStorage,gt.A.EnhancedXRFImageStorage,gt.A.XRay3DAngiographicImageStorage,gt.A.XRay3DCraniofacialImageStorage,gt.A.BreastTomosynthesisImageStorage,gt.A.BreastProjectionXRayImageStorageForPresentation,gt.A.BreastProjectionXRayImageStorageForProcessing,gt.A.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,gt.A.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,gt.A.NuclearMedicineImageStorage,gt.A.VLEndoscopicImageStorage,gt.A.VideoEndoscopicImageStorage,gt.A.VLMicroscopicImageStorage,gt.A.VideoMicroscopicImageStorage,gt.A.VLSlideCoordinatesMicroscopicImageStorage,gt.A.VLPhotographicImageStorage,gt.A.VideoPhotographicImageStorage,gt.A.OphthalmicPhotography8BitImageStorage,gt.A.OphthalmicPhotography16BitImageStorage,gt.A.OphthalmicTomographyImageStorage,gt.A.VLWholeSlideMicroscopyImageStorage,gt.A.PositronEmissionTomographyImageStorage,gt.A.EnhancedPETImageStorage,gt.A.LegacyConvertedEnhancedPETImageStorage,gt.A.RTImageStorage,gt.A.EnhancedUSVolumeStorage];const At=function(){return[{name:Mt,sopClassUids:Pt,getDisplaySetsFromSeries:Ct},{name:"not-supported-display-sets-handler",sopClassUids:[],getDisplaySetsFromSeries:Ut}]};function Ot(){return ve.createElement("span",{className:"border-common-dark mx-2 h-8 w-4 self-center border-l"})}function Tt(){return Tt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},Tt.apply(this,arguments)}function Ft({rows:e,columns:t,className:a,onSelection:n,...s}){const[r,i]=(0,ve.useState)(!1),o=()=>{r&&i(!1)};(0,ve.useEffect)((()=>(window.addEventListener("click",o),()=>{window.removeEventListener("click",o)})),[r]);const c=r?Ee.sG:null;return ve.createElement(Ee.IB,{id:"Layout",label:"Grid Layout",icon:"tool-layout",onInteraction:()=>i(!r),className:a,rounded:s.rounded,dropdownContent:null!==c&&ve.createElement(c,{rows:e,columns:t,onSelection:n}),isActive:r,type:"toggle"})}Ft.propTypes={rows:we().number,columns:we().number,onLayoutChange:we().func,servicesManager:we().instanceOf(i.CS)},Ft.defaultProps={rows:3,columns:3,onLayoutChange:()=>{}};const Lt=function({servicesManager:e,...t}){const{toolbarService:a}=e.services,n=(0,ve.useCallback)((e=>{a.recordInteraction({interactionType:"action",commands:[{commandName:"setViewportGridLayout",commandOptions:{...e},context:"DEFAULT"}]})}),[a]);return ve.createElement(Ft,Tt({},t,{onSelection:n}))};function kt(){return kt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},kt.apply(this,arguments)}function Vt({isRadio:e,isAction:t,groupId:a,primary:n,secondary:s,items:r,renderer:i,onInteraction:o,servicesManager:c}){const{toolbarService:l}=c?.services,u=(n,s)=>{const{id:i,type:c,commands:l}=n;o({groupId:a,itemId:i,interactionType:c,commands:l}),I((a=>({...a,primary:!t&&e?{...n,index:s}:a.primary,isExpanded:!1,items:d(r).filter((a=>!(e&&!t)||a.index!==s))})))},d=e=>e.map(((e,t)=>({...e,index:t,onClick:()=>u(e,t)}))),[m,p]=(0,ve.useState)({primaryToolId:"",toggles:{},groups:{}}),[g,I]=(0,ve.useState)({primary:n,items:d(r).filter((a=>!(e&&!t)||a.id!==n.id))}),{primaryToolId:f,toggles:S}=m,y="toggle"===g.primary.type,h="tool"===g.primary.type&&f===g.primary.id||y&&!0===S[g.primary.id],D=l?.getButtonComponentForUIType(g.primary.uiType)??Ee.IB;(0,ve.useEffect)((()=>{const{unsubscribe:e}=l.subscribe(l.EVENTS.TOOL_BAR_STATE_MODIFIED,(e=>{p({...e})}));return()=>{e()}}),[l]);const v=g.items.map((e=>{const t="tool"===e.type&&f===e.id;return{...e,isActive:t}})),b=i||(({type:e,icon:t,label:a,t:n,id:s})=>{const r="toggle"===e&&!0===S[s];return ve.createElement("div",{className:Pe()("hover:bg-primary-dark flex h-8 w-full flex-row items-center p-3","whitespace-pre text-base",r&&"bg-primary-dark",r?"text-[#348CFD]":"text-common-bright hover:bg-primary-dark hover:text-primary-light")},t&&ve.createElement("span",{className:"mr-4"},ve.createElement(Ee.In,{name:t,className:"h-5 w-5"})),ve.createElement("span",{className:"mr-5"},n(a)))});return ve.createElement(Ee.fk,{isRadio:e,isAction:t,primary:g.primary,secondary:s,items:v,groupId:a,renderer:b,isActive:h||v.some((e=>e.isActive)),isToggle:y,onInteraction:o,Component:e=>ve.createElement(D,kt({},e,{servicesManager:c}))})}Vt.propTypes={isRadio:we().bool,isAction:we().bool,groupId:we().string,primary:we().shape({id:we().string.isRequired,type:we().oneOf(["tool","action","toggle"]).isRequired,uiType:we().string}),secondary:we().shape({id:we().string,icon:we().string.isRequired,label:we().string,tooltip:we().string.isRequired,isActive:we().bool}),items:we().arrayOf(we().shape({id:we().string.isRequired,type:we().oneOf(["tool","action","toggle"]).isRequired,icon:we().string,label:we().string,tooltip:we().string})),renderer:we().func,onInteraction:we().func.isRequired,servicesManager:we().shape({services:we().shape({toolbarService:we().object})})},Vt.defaultProps={isRadio:!1,isAction:!1};const $t=Vt;function qt(){return qt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},qt.apply(this,arguments)}function _t({id:e,type:t,commands:a,onInteraction:n,servicesManager:s,...r}){const{toolbarService:i}=s?.services||{},[o,c]=(0,ve.useState)({primaryToolId:"",toggles:{},groups:{}}),{primaryToolId:l}=o,u="tool"===t&&e===l||"toggle"===t&&!0===o.toggles[e];return(0,ve.useEffect)((()=>{const{unsubscribe:e}=i.subscribe(i.EVENTS.TOOL_BAR_STATE_MODIFIED,(e=>{c({...e})}));return()=>{e()}}),[i]),ve.createElement(Ee.IB,qt({commands:a,id:e,type:t,isActive:u,onInteraction:n},r))}_t.propTypes={id:we().string.isRequired,type:we().oneOf(["tool","action","toggle"]).isRequired,commands:we().arrayOf(we().shape({commandName:we().string.isRequired,context:we().string})),onInteraction:we().func.isRequired,servicesManager:we().shape({services:we().shape({toolbarService:we().shape({subscribe:we().func.isRequired,state:we().shape({primaryToolId:we().string,toggles:we().objectOf(we().bool),groups:we().objectOf(we().any)}).isRequired}).isRequired}).isRequired}).isRequired};const jt=_t;function Bt(e,t,a,n){const s={selectorProps:e,event:t},r=function(e,t,a){const{subMenu:n}=t,s=function*(){yield function(e,t){if(t)return e.find((e=>e.id===t))}(e,a||n),yield function(e,t){return e?e.find((e=>!e.selector||e.selector(t.selectorProps))):null}(e,t)}();let r=s.next(),i=r.value;for(;!r.done;)i=r.value,i&&s.return(),r=s.next();return console.log("Menu chosen",i?.id||"NONE"),i}(a,s,n);if(!r)return;if(!r.items)return console.warn("Must define items in menu",r),[];let i=[];return r.items.forEach((n=>{const{delegating:r,selector:o,subMenu:c}=n;if(!o||o(e))if(r)i=[...i,...Bt(e,t,a,c)];else{const e=function(e,t){const a={...e,value:t.selectorProps?.value};"ShowSubMenu"!==e.actionType||a.iconRight||(a.iconRight="chevron-menu");e.action||(a.action=(e,n)=>{const{event:s={}}=n,{detail:r={}}=s;a.element=r.element,n.onClose();const i=n[`on${e.actionType||"Default"}`];i?i.call(n,a,e,t):console.warn("No action defined for",e)});return a}(n,s);i.push(e)}})),i}var Ht,Gt=a(59852),zt=a(20767);class Wt{constructor(e,t){this.commandsManager=void 0,this.services=void 0,this.menuItems=void 0,this.services=e.services,this.commandsManager=t}closeContextMenu(){this.services.uiDialogService.dismiss({id:"context-menu"})}showContextMenu(e,t,a){if(!this.services.uiDialogService)return void console.warn("Unable to show dialog; no UI Dialog Service available.");const{event:n,subMenu:s,menuId:r,menus:i,selectorProps:o}=e,c=zt.annotation.state.getAnnotationManager(),{locking:l}=zt.annotation,u=o?.nearbyToolData?.annotationUID;if(l.isAnnotationLocked(c.getAnnotation(u)))return void console.warn("Annotation is locked.");console.log("Getting items from",i);const d=Bt(o||e,n,i,r);this.services.uiDialogService.dismiss({id:"context-menu"}),this.services.uiDialogService.create({id:"context-menu",isDraggable:!1,preservePosition:!1,preventCutOf:!0,defaultPosition:Wt._getDefaultPosition(a,n?.detail,t),event:n,content:Gt.A,onClickOutside:()=>this.services.uiDialogService.dismiss({id:"context-menu"}),contentProps:{items:d,selectorProps:o,menus:i,event:n,subMenu:s,eventData:n?.detail,onClose:()=>{this.services.uiDialogService.dismiss({id:"context-menu"})},onShowSubMenu:(n,s,r)=>{s.subMenu?this.showContextMenu({...e,menuId:s.subMenu},t,a):console.warn("No submenu defined for",n,s,r)},onDefault:(e,t,a)=>{this.commandsManager.run(e,{...o,...t,subProps:a})}}})}}Ht=Wt,Wt.getDefaultPosition=()=>({x:0,y:0}),Wt._getEventDefaultPosition=e=>({x:e&&e.currentPoints.client[0],y:e&&e.currentPoints.client[1]}),Wt._getElementDefaultPosition=e=>{if(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y}}return{x:void 0,y:void 0}},Wt._getCanvasPointsPosition=(e=[],t)=>{const a=Ht._getElementDefaultPosition(t);for(let t=0;t<e.length;t++){const n={x:e[t][0]||e[t].x,y:e[t][1]||e[t].y};if(Ht._isValidPosition(n)&&Ht._isValidPosition(a))return{x:n.x+a.x,y:n.y+a.y}}},Wt._isValidPosition=e=>e&&"number"==typeof e.x&&"number"==typeof e.y,Wt._getDefaultPosition=(e,t,a)=>{const n=function*(){yield Ht._getCanvasPointsPosition(e,a),yield Ht._getEventDefaultPosition(t),yield Ht._getElementDefaultPosition(a),yield Ht.getDefaultPosition()}();let s=n.next(),r=s.value;for(;!s.done;)r=s.value,Ht._isValidPosition(r)&&n.return(),s=n.next();return r};const Jt={id:"measurementsContextMenu",customizationType:"ohif.contextMenu",menus:[{id:"forExistingMeasurement",selector:({nearbyToolData:e})=>!!e,items:[{label:"Delete measurement",commands:[{commandName:"deleteMeasurement"}]},{label:"Add Label",commands:[{commandName:"setMeasurementLabel"}]}]}]};var Yt=a(8291),Xt=a.n(Yt),Kt=a(6943);const Qt={padding:"10px 0"},Zt={borderBottomWidth:"1px",...Qt};function ea({tagRef:e,vrRef:t,keywordRef:a,valueRef:n}){return ve.createElement("div",{className:Pe()("bg-secondary-dark ohif-scrollbar flex w-full flex-row overflow-y-scroll"),style:Qt},ve.createElement("div",{className:"w-4/24 px-3"},ve.createElement("label",{ref:e,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},ve.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Tag"))),ve.createElement("div",{className:"w-2/24 px-3"},ve.createElement("label",{ref:t,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},ve.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"VR"))),ve.createElement("div",{className:"w-6/24 px-3"},ve.createElement("label",{ref:a,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},ve.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Keyword"))),ve.createElement("div",{className:"w-5/24 grow px-3"},ve.createElement("label",{ref:n,className:"flex flex-1 select-none flex-col pl-1 text-lg text-white"},ve.createElement("span",{className:"flex flex-row items-center focus:outline-none"},"Value"))))}const ta=function({rows:e}){const t=(0,ve.useRef)(),a=(0,ve.useRef)(),[n,s]=(0,ve.useState)(null),[r,i]=(0,ve.useState)(null),[o,c]=(0,ve.useState)(null),[l,u]=(0,ve.useState)(null);(0,ve.useEffect)((()=>{t?.current&&(t.current.scrollTo(0),t.current.resetAfterIndex(0))}),[e]),(0,ve.useEffect)((()=>{const e=tt()((()=>t.current.resetAfterIndex(0)),100);return window.addEventListener("resize",e),()=>{e.cancel(),window.removeEventListener("resize",e)}}),[]);const d=(0,ve.useCallback)((({index:t,style:a})=>{const n=e[t];return ve.createElement("div",{style:{...a,...Zt},className:Pe()("hover:bg-secondary-main border-secondary-light flex w-full flex-row items-center break-all bg-black text-base transition duration-300","leading-[20px]"),key:`DICOMTagRow-${t}`},ve.createElement("div",{className:"w-4/24 px-3"},n[0]),ve.createElement("div",{className:"w-2/24 px-3"},n[1]),ve.createElement("div",{className:"w-6/24 px-3"},n[2]),ve.createElement("div",{className:"w-5/24 grow px-3"},n[3]))}),[e]),m=(0,ve.useCallback)((()=>null!==n),[n]),p=(0,ve.useCallback)((t=>{const s=[n.offsetWidth,r.offsetWidth,o.offsetWidth,l.offsetWidth],i=a.current.getContext("2d");return i.font=getComputedStyle(a.current).font,e[t].map(((e,t)=>{const a=i.measureText(e).width;return 20*Math.ceil(a/s[t])+20+1})).reduce(((e,t)=>Math.max(e,t)))}),[e,o,n,l,r]);return ve.createElement("div",null,ve.createElement("canvas",{style:{visibility:"hidden",position:"absolute"},className:"text-base",ref:a}),ve.createElement(ea,{tagRef:e=>{e&&s(e)},vrRef:e=>{e&&i(e)},keywordRef:e=>{e&&c(e)},valueRef:e=>{e&&u(e)}}),ve.createElement("div",{className:"relative m-auto border-2 border-black bg-black",style:{height:"32rem"}},m()&&ve.createElement(Kt._m,{ref:t,height:500,itemCount:e.length,itemSize:p,width:"100%",className:"ohif-scrollbar"},d)))},{ImageSet:aa}=i.classes,{DicomMetaDictionary:na}=I.Ay.data,{nameMap:sa}=na;function ra(e,t){const a=[];return e.forEach((e=>{if("SQ"===e.vr){a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,""]);const{values:n}=e;n.forEach(((e,n)=>{const s=ra(e,t);a.push([`${e[0].tagIndent}(FFFE,E000)`,"",`Item #${n}`,""]),a.push(...s)}))}else{if("xs"===e.vr)try{const a=I.Ay.data.Tag.fromPString(e.tag).toCleanString(),n=t[a];e.vr=n.vr}catch(t){console.error(`Failed to parse value representation for tag '${e.keyword}'`)}a.push([`${e.tagIndent}${e.tag}`,e.vr,e.keyword,e.value])}})),a}function ia(e,t=0){const a=Object.keys(e);let n="";for(let e=0;e<t;e++)n+=">";t>0&&(n+=" ");const s=[];for(let i=0;i<a.length;i++){let o=a[i];if("_vrMap"===o)continue;const c=sa[o];let l=e[o];if(c&&"SQ"===c.vr){const e=(r=l,Array.isArray(r)?r:[r]),a={tag:c.tag,tagIndent:n,vr:c.vr,keyword:o,values:[]};if(s.push(a),null===l)continue;e.forEach((e=>{const n=ia(e,t+1);n.length&&(oa(n),a.values.push(n))}))}else if(Array.isArray(l)&&l.length>0&&"object"!=typeof l[0]&&(l=l.join("\\")),"number"==typeof l&&(l=l.toString()),"string"!=typeof l&&(null===l?l=" ":"object"==typeof l?l.InlineBinary?l="Inline Binary":l.BulkDataURI?l="Bulk Data URI":l.Alphabetic?l=l.Alphabetic:(console.warn(`Unrecognised Value: ${l} for ${o}:`),console.warn(l),l=" "):(console.warn(`Unrecognised Value: ${l} for ${o}:`),l=" ")),o=o.replace("RETIRED_",""),c)s.push({tag:c.tag,tagIndent:n,vr:c.vr,keyword:o,value:l});else{const e=/[0-9A-Fa-f]{6}/g;if(o.match(e)){const e=`(${o.substring(0,4)},${o.substring(4,8)})`;s.push({tag:e,tagIndent:n,vr:"",keyword:"Private Tag",value:l})}}}var r;return s}function oa(e){e.sort(((e,t)=>e.tag<t.tag?-1:1))}const ca=({displaySets:e,displaySetInstanceUID:t})=>{const a=new Set([1]),[n,s]=(0,ve.useState)(t),[r,i]=(0,ve.useState)(1),[o,c]=(0,ve.useState)(""),l=e.find((e=>e.displaySetInstanceUID===n)),u=l instanceof aa;const d=u&&l.images.length>1,m=(0,ve.useMemo)((()=>(e.sort(((e,t)=>e.SeriesNumber-t.SeriesNumber)),e.map((e=>{const{displaySetInstanceUID:t,SeriesDate:a,SeriesTime:n,SeriesNumber:s,SeriesDescription:r,Modality:i}=e,o=`${a}:${n}`.split(".")[0];return{value:t,label:`${s} (${i}): ${r}`,description:Xt()(o,"YYYYMMDD:HHmmss").format("ddd, MMM Do YYYY")}})))),[e]),p=(0,ve.useMemo)((()=>{let e;e=u?l.images[r-1]:l.instance||l;const t=function(e){const t=ia(e);return oa(t),t}(e);return ra(t,e)}),[r,n]),g=(0,ve.useMemo)((()=>{if(!o)return p;const e=o.toLowerCase();return p.filter((t=>t.reduce(((t,n,s)=>t||(a.has(s)?t:t||n.toLowerCase().includes(e))),!1)))}),[p,o]),I=(0,ve.useMemo)((()=>tt()(c,200)),[]);return(0,ve.useEffect)((()=>()=>{I?.cancel()}),[]),ve.createElement("div",{className:"dicom-tag-browser-content"},ve.createElement("div",{className:"mb-6 flex flex-row items-center pl-1"},ve.createElement("div",{className:"flex w-1/2 flex-row items-center"},ve.createElement(Ee.o5,{variant:"subtitle",className:"mr-4"},"Series"),ve.createElement("div",{className:"mr-8 grow"},ve.createElement(Ee.l6,{id:"display-set-selector",isClearable:!1,onChange:e=>{s(e.value),i(1)},options:m,value:m.find((e=>e.value===n)),className:"text-white"}))),ve.createElement("div",{className:"flex w-1/2 flex-row items-center"},d&&ve.createElement(Ee.o5,{variant:"subtitle",className:"mr-4"},"Instance Number"),d&&ve.createElement("div",{className:"grow"},ve.createElement(Ee.Qr,{value:r,key:n,onChange:e=>{i(parseInt(e))},minValue:1,maxValue:l.images.length,step:1,inputClassName:"w-full",labelPosition:"left",trackColor:"#3a3f99"})))),ve.createElement("div",{className:"h-1 w-full bg-black"}),ve.createElement("div",{className:"my-3 flex w-1/2 flex-row"},ve.createElement(Ee.Cv,{className:"mr-8 block w-full",placeholder:"Search metadata...",onDebounceChange:c})),ve.createElement(ta,{rows:g}))},la=(e,t,a)=>{const{activeViewportId:n}=e,{protocol:s}=t.getActiveProtocol(),r=t.getState(),{protocolId:i,stageIndex:o,activeStudyUID:c}=r,l=a.getState(),u={...l.viewportGridStore},d={...l.displaySetSelectorMap},m=s.stages[o],p=`${c}:${i}:${o}`,g=`${c}:${i}`,I={...l.hangingProtocolStageIndexMap},{rows:f,columns:S}=m.viewportStructure.properties,y=m.viewports.length!==e.viewports.size||e.layout.numRows!==f||e.layout.numCols!==S;return I[g]=r,p&&y&&(u[p]={...e}),e.viewports.forEach(((e,t)=>{const{displaySetOptions:a,displaySetInstanceUIDs:s}=e;if(a)for(let e=0;e<a.length;e++){const r=s[e];r&&(t===n&&0===e&&(d[`${c}:activeDisplaySet:0`]=r),a[e]?.id&&(d[`${c}:${a[e].id}:${a[e].matchedDisplaySetsIndex||0}`]=r))}})),{hangingProtocolStageIndexMap:I,viewportGridStore:u,displaySetSelectorMap:d}},ua=(e,t,a,n,s)=>{const r=t?.[n];if(r)return{...r};const{protocolId:i,stageIndex:o}=e.getState();s.inDisplay||(s.inDisplay=[...t.initialInDisplay]);const c=e.getMissingViewport(i,o,s);if(c){const e=c.displaySetsInfo.map((e=>e.displaySetInstanceUID));return s.inDisplay.push(...e),{displaySetInstanceUIDs:e,displaySetOptions:c.displaySetsInfo.map((e=>e.displaySetOptions)),viewportOptions:{...c.viewportOptions}}}return{}},da=(e,{numRows:t,numCols:a},n)=>{const{viewports:s}=e,r={...n.getState().viewportsByPosition},i=[];s.forEach((e=>{if(e.positionId){const t={...e,viewportOptions:{...e.viewportOptions}};r[e.positionId]=t}}));for(let e=0;e<t;e++)for(let t=0;t<a;t++){const a=r[`${t}-${e}`];a?.displaySetInstanceUIDs&&i.push(...a.displaySetInstanceUIDs)}return r.initialInDisplay=i,{viewportsByPosition:r}};var ma=a(45573);const{subscribeToNextViewportGridChange:pa}=i.utils,ga=e=>e&&("setHangingProtocol"===e.commandName||"toggleHangingProtocol"===e.commandName),Ia=({servicesManager:e,commandsManager:t})=>{const{customizationService:a,measurementService:n,hangingProtocolService:s,uiNotificationService:r,viewportGridService:i,displaySetService:o,stateSyncService:c,toolbarService:l}=e.services,u=new Wt(e,t),d={showContextMenu:e=>{const{menuCustomizationId:t,element:n,event:r,selectorProps:i,defaultPointsPosition:o=[]}=e,c={...e};t&&Object.assign(c,a.get(t,Jt));const{protocol:l,stage:d}=s.getActiveProtocol();c.selectorProps={event:r,protocol:l,stage:d,...i},u.showContextMenu(c,n,o)},closeContextMenu:()=>{u.closeContextMenu()},displayNotification:({text:e,title:t,type:a})=>{r.show({title:t,message:e,type:a})},clearMeasurements:()=>{n.clear()},toggleHpTools:()=>{const{protocol:e,stageIndex:t,stage:a}=s.getActiveProtocol(),n=s=>{if(!s.id)return;const{commands:r,items:i,primary:o}=s.props||s;o&&n(o),i&&i.forEach(n);const c=r?.find?.(ga);if(!c)return;const{protocolId:u,stageIndex:d,stageId:m}=c.commandOptions,p=!(u&&u!==e.id||void 0!==d&&d!==t||m&&m!==a.id);l.setToggled(s.id,p)};Object.values(l.getButtons()).forEach(n)},setHangingProtocol:({activeStudyUID:e="",protocolId:t,stageId:a,stageIndex:n,reset:o=!1})=>{const u=l.getActivePrimaryTool();try{const r=i.getState(),m=s.getState(),{protocol:p}=s.getActiveProtocol(),g=la(r,s,c),{hangingProtocolStageIndexMap:I,viewportGridStore:f,displaySetSelectorMap:S}=g;if(t){if(void 0===n&&void 0===a){const a=`${e||m.activeStudyUID}:${t}`;n=I[a]?.stageIndex}}else t=m.protocolId,void 0===a&&void 0===n&&(n=m.stageIndex);const y=n??s.getStageIndex(t,{stageId:a,stageIndex:n});e&&s.setActiveStudyUID(e);const h=`${s.getState().activeStudyUID}:${t}:${y||0}`,D=!o&&f[h];t!==m.protocolId||y!==m.stageIndex||e?(s.setProtocol(t,{displaySetSelectorMap:S,stageId:a,stageIndex:y,restoreProtocol:D}),D&&i.set(f[h])):s.setProtocol(t,{stageId:a,stageIndex:y}),delete S[`${e||m.activeStudyUID}:activeDisplaySet:0`],c.store(g),d.toggleHpTools();const v=l.getButton(u);if(v){let e=v.props?.interactionType;if(!e&&v.props?.items){const t=v.props.items[0];e=t.props?.interactionType||t.props?.type}e&&l.recordInteraction({interactionType:e,...v.props})}return!0}catch(e){return console.error(e),d.toggleHpTools(),r.show({title:"Apply Hanging Protocol",message:"The hanging protocol could not be applied.",type:"error",duration:3e3}),!1}},toggleHangingProtocol:({protocolId:e,stageIndex:t})=>{const{protocol:a,stageIndex:n,activeStudy:r}=s.getActiveProtocol(),{toggleHangingProtocol:i}=c.getState(),o=`${r.StudyInstanceUID}:${e}:${0|t}`;if(a.id!==e||void 0!==t&&t!==n)return c.store({toggleHangingProtocol:{...i,[o]:{protocolId:a.id,stageIndex:n}}}),d.setHangingProtocol({protocolId:e,stageIndex:t,reset:!0});{const e=i[o]||{protocolId:"default"};return d.setHangingProtocol(e)}},deltaStage:({direction:e})=>{const{protocolId:t,stageIndex:a}=s.getState(),{protocol:n}=s.getActiveProtocol();for(let s=a+e;s>=0&&s<n.stages.length;s+=e)if("disabled"!==n.stages[s].status)return d.setHangingProtocol({protocolId:t,stageIndex:s});r.show({title:"Change Stage",message:"The hanging protocol has no more applicable stages",type:"info",duration:3e3})},setViewportGridLayout:({numRows:e,numCols:a})=>{const{protocol:n}=s.getActiveProtocol(),r=n.callbacks?.onLayoutChange;if(!1===t.run(r,{numRows:e,numCols:a}))return void console.log("setViewportGridLayout running",r,e,a);window.setTimeout((()=>{const t=i.getState(),n=da(t,{numRows:e,numCols:a},c),r=ua.bind(null,s,n.viewportsByPosition);i.setLayout({numRows:e,numCols:a,findOrCreateViewport:r}),c.store(n)}),0)},toggleOneUp(){const e=i.getState(),{activeViewportId:t,viewports:a,layout:n}=e,{displaySetInstanceUIDs:r,displaySetOptions:o,viewportOptions:l}=a.get(t);if(1===n.numCols&&1===n.numRows){const{toggleOneUpViewportGridStore:e}=c.getState();if(!e.layout)return;const t=e.activeViewportId,a=r.length>1?[]:r.map((e=>s.getViewportsRequireUpdate(t,e))).flat(),n=(t,n)=>{const s=Array.from(e.viewports.values()).find((e=>e.positionId===n)),r=a.find((e=>e.viewportId===s.viewportId));return r?{viewportOptions:l,displaySetOptions:o,...r}:s},u=i.getLayoutOptionsFromState(e);i.setLayout({numRows:e.layout.numRows,numCols:e.layout.numCols,activeViewportId:t,layoutOptions:u,findOrCreateViewport:n})}else{c.store({toggleOneUpViewportGridStore:e});const t=()=>({displaySetInstanceUIDs:r,displaySetOptions:o,viewportOptions:l});i.setLayout({numRows:1,numCols:1,findOrCreateViewport:t});pa(i,(()=>{c.store({toggleOneUpViewportGridStore:{}})}))}},navigateHistory(e){ma.b.navigate(e.to,e.options)},openDICOMTagViewer(){const{activeViewportId:t,viewports:a}=i.getState(),n=a.get(t),{displaySetInstanceUIDs:s}=n,r=o.activeDisplaySets,{UIModalService:c}=e.services,l=s[0];c.show({content:ca,contentProps:{displaySets:r,displaySetInstanceUID:l,onClose:c.hide},title:"DICOM Tag Browser"})},toggleOverlays:()=>{const e=document.getElementsByClassName("viewport-overlay");for(let t=0;t<e.length;t++)e.item(t).classList.toggle("hidden")},scrollActiveThumbnailIntoView:()=>{const{activeViewportId:e,viewports:t}=i.getState(),a=t.get(e).displaySetInstanceUIDs[0],n=document.querySelector("#ohif-thumbnail-list");if(!n)return;const s=n.getBoundingClientRect(),r=document.querySelector(`#thumbnail-${a}`);if(!r)return;const o=r.getBoundingClientRect();o.top>=s.top&&o.top<=s.bottom||r.scrollIntoView({behavior:"smooth"})},updateViewportDisplaySet:({direction:e,excludeNonImageModalities:t})=>{const a=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],n=s.getDisplaySetSortFunction(),c=[...o.activeDisplaySets];c.sort(n);const{activeViewportId:l,viewports:u}=i.getState(),{displaySetInstanceUIDs:m}=u.get(l);let p;for(p=c.findIndex((e=>m.includes(e.displaySetInstanceUID)))+e;p>-1&&p<c.length&&(t&&a.includes(c[p].Modality));p+=e);if(p<0||p>=c.length)return;const{displaySetInstanceUID:g}=c[p];let I=[];try{I=s.getViewportsRequireUpdate(l,g)}catch(e){console.warn(e),r.show({title:"Navigate Viewport Display Set",message:"The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.",type:"info",duration:3e3})}i.setDisplaySetsForViewports(I),setTimeout((()=>d.scrollActiveThumbnailIntoView()),0)}},m={showContextMenu:{commandFn:d.showContextMenu},closeContextMenu:{commandFn:d.closeContextMenu},clearMeasurements:{commandFn:d.clearMeasurements,storeContexts:[],options:{}},displayNotification:{commandFn:d.displayNotification,storeContexts:[],options:{}},setHangingProtocol:{commandFn:d.setHangingProtocol,storeContexts:[],options:{}},toggleHangingProtocol:{commandFn:d.toggleHangingProtocol,storeContexts:[],options:{}},navigateHistory:{commandFn:d.navigateHistory,storeContexts:[],options:{}},nextStage:{commandFn:d.deltaStage,storeContexts:[],options:{direction:1}},previousStage:{commandFn:d.deltaStage,storeContexts:[],options:{direction:-1}},setViewportGridLayout:{commandFn:d.setViewportGridLayout,storeContexts:[],options:{}},toggleOneUp:{commandFn:d.toggleOneUp,storeContexts:[],options:{}},openDICOMTagViewer:{commandFn:d.openDICOMTagViewer},updateViewportDisplaySet:{commandFn:d.updateViewportDisplaySet,storeContexts:[],options:{}}};return{actions:d,definitions:m,defaultContext:"DEFAULT"}},fa={id:"@ohif/mnGrid",description:"Has various hanging protocol grid layouts",name:"2x2",protocolMatchingRules:[{id:"OneOrMoreSeries",weight:25,attribute:"numberOfDisplaySetsWithImages",constraint:{greaterThan:0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}},required:!0},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{id:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:2,id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:3,id:"defaultDisplaySetId"}]}]},{id:"3x1",requiredViewports:1,preferredViewports:3,stageActivation:{enabled:{minViewportsMatched:3}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:1}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:2}]}]},{id:"2x1",requiredViewports:1,preferredViewports:2,stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]},{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{matchedDisplaySetsIndex:1,id:"defaultDisplaySetId"}]}]},{id:"1x1",requiredViewports:1,preferredViewports:1,stageActivation:{enabled:{minViewportsMatched:1}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId"}]}]}],numberOfPriorsReferenced:-1},Sa={id:"defaultDisplaySetId"},ya={id:"priorDisplaySetId"},ha={viewportOptions:{toolGroupId:"default",allowUnmatchedView:!0},displaySets:[Sa]},Da={...ha,displaySets:[{...Sa,matchedDisplaySetsIndex:1}]},va={...ha,displaySets:[ya]},ba={id:"@ohif/hpCompare",description:"Compare two studies in various layouts",name:"Compare Two Studies",numberOfPriorsReferenced:1,protocolMatchingRules:[{id:"Two Studies",weight:1e3,attribute:"StudyInstanceUID",from:"prior",required:!0,constraint:{notNull:!0}}],toolGroupIds:["default"],displaySetSelectors:{defaultDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:0}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]},priorDisplaySetId:{studyMatchingRules:[{attribute:"studyInstanceUIDsIndex",from:"options",required:!0,constraint:{equals:{value:1}}}],seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},stages:[{name:"2x2",stageActivation:{enabled:{minViewportsMatched:4}},viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[ha,va,Da,{...va,displaySets:[{...ya,matchedDisplaySetsIndex:1}]}]},{name:"2x1",stageActivation:{enabled:{minViewportsMatched:2}},viewportStructure:{layoutType:"grid",properties:{rows:1,columns:2}},viewports:[ha,va]}]},wa={id:"default",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2023-04-01",availableTo:{},editableBy:{},protocolMatchingRules:[],toolGroupIds:["default"],hpInitiationCriteria:{minSeriesLoaded:1},numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"defaultDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{defaultDisplaySetId:{seriesMatchingRules:[{attribute:"numImageFrames",constraint:{greaterThan:{value:0}}},{attribute:"isDisplaySetFromUrl",weight:10,constraint:{equals:!0}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{viewportType:"stack",viewportId:"default",toolGroupId:"default",initialImageOptions:{custom:"sopInstanceLocation"}},displaySets:[{id:"defaultDisplaySetId"}]}],createdDate:"2021-02-23T18:32:42.850Z"}]};const Ea=function(){return[{name:wa.id,protocol:wa},{name:fa.id,protocol:fa},{name:ba.id,protocol:ba}]};const Ua=function(){const[e]=(0,Ue.r)(),t=(0,Me.Zp)(),a=e.dataSources;return ve.createElement("div",{style:{width:"100%",height:"100%"}},ve.createElement("div",{className:"flex h-screen w-screen items-center justify-center "},ve.createElement("div",{className:"bg-secondary-dark mx-auto space-y-2 rounded-lg py-8 px-8 drop-shadow-md"},ve.createElement("img",{className:"mx-auto block h-14",src:"./ohif-logo.svg",alt:"OHIF"}),ve.createElement("div",{className:"space-y-2 pt-4 text-center"},a.filter((e=>"dicomjson"!==e.sourceName&&"dicomlocal"!==e.sourceName)).map((e=>ve.createElement("div",{key:e.sourceName},ve.createElement("h1",{className:"text-white"},e.configuration?.friendlyName||e.friendlyName),ve.createElement(Ee.$n,{type:Ee.Ny.NW.primary,className:Pe()("ml-2"),onClick:()=>{t({pathname:"/",search:`datasources=${e.sourceName}`})}},e.sourceName),ve.createElement("br",null))))))))};const Ma=function({itemLabel:e,itemList:t,onItemClicked:a}){const{t:n}=(0,Ne.Bd)("DataSourceConfiguration"),[s,r]=(0,ve.useState)("");return(0,ve.useEffect)((()=>{r("")}),[t]),ve.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},ve.createElement("div",{className:"flex items-center justify-between"},ve.createElement("div",{className:"text-primary-light text-[20px]"},n(`Select ${e}`)),ve.createElement(Ee.Cv,{className:"max-w-[40%] grow",value:s,onDebounceChange:r,placeholder:n(`Search ${e} list`)})),ve.createElement("div",{className:"relative flex min-h-[1px] grow flex-col bg-black text-[14px]"},null==t?ve.createElement(Ee.Jx,{className:"h-full w-full"}):0===t.length?ve.createElement("div",{className:"text-primary-light flex h-full flex-col items-center justify-center px-6 py-4"},ve.createElement(Ee.In,{name:"magnifier",className:"mb-4"}),ve.createElement("span",null,n(`No ${e} available`))):ve.createElement(ve.Fragment,null,ve.createElement("div",{className:"bg-secondary-dark px-3 py-1.5 text-white"},n(e)),ve.createElement("div",{className:"ohif-scrollbar overflow-auto"},t.filter((e=>!s||e.name.toLowerCase().includes(s.toLowerCase()))).map((e=>ve.createElement("div",{className:Pe()("hover:text-primary-light hover:bg-primary-dark group mx-2 flex items-center justify-between px-6 py-2","rounded border-transparent border-b-secondary-light border-[1px] hover:border-primary-light"),key:e.id},ve.createElement("div",null,e.name),ve.createElement(Ee.$n,{onClick:()=>a(e),className:"invisible group-hover:visible",endIcon:ve.createElement(Ee.In,{name:"arrow-left"})},n("Select")))))))))},Na="text-ellipsis whitespace-nowrap overflow-hidden";const xa=function({configurationAPI:e,configuredItems:t,onHide:a}){const{t:n}=(0,Ne.Bd)("DataSourceConfiguration"),[s,r]=(0,ve.useState)(),[i,o]=(0,ve.useState)(t),[c,l]=(0,ve.useState)(),[u]=(0,ve.useState)(e.getItemLabels()),[d,m]=(0,ve.useState)(u.length===t.length),p=d?i.length-2:i.length-1;(0,ve.useEffect)((()=>{let t=!0;return l(null),r(null),0===i.length?e.initialize().then((e=>{t&&r(e)})).catch((e=>l(e.message))):d||i.length!==u.length?e.setCurrentItem(i[p]).then((e=>{t&&r(e)})).catch((e=>l(e.message))):(e.setCurrentItem(i[i.length-1]),a()),()=>{t=!1}}),[i,e,a,u,d,p]);const g=e=>e<i.length?Pe()("bg-black/[.4]",e!==u.length-1?"hover:bg-transparent active:bg-secondary-dark":""):"bg-transparent",I=e=>e===p+1?Pe()("border-2","border-solid","border-primary-light"):e<i.length?"border border-solid border-primary-active hover:border-primary-light active:border-white":"border border-dashed border-secondary-light",f=e=>e<=i.length?"text-primary-light":"text-primary-active";return ve.createElement("div",{className:"flex h-[calc(100vh-300px)] select-none flex-col gap-4 pt-0.5"},ve.createElement("div",{className:"flex gap-4"},u.map(((e,t)=>{return ve.createElement("div",{key:e,className:Pe()("flex min-w-[1px] shrink basis-[200px] flex-col gap-1 rounded-md p-3.5",(a=t,a!==u.length-1&&a<i.length?"cursor-pointer":"cursor-auto"),g(t),I(t),f(t)),onClick:d&&t<p||t<=p?()=>{m(!1),o((e=>e.slice(0,t)))}:void 0},ve.createElement("div",{className:"text- flex items-center gap-2"},t<i.length?ve.createElement(Ee.In,{name:"status-tracked"}):ve.createElement(Ee.In,{name:"status-untracked"}),ve.createElement("div",{className:Pe()(Na)},n(e))),t<i.length?ve.createElement("div",{className:Pe()("text-[14px] text-white",Na)},i[t].name):ve.createElement("br",null));var a}))),ve.createElement("div",{className:"h-0.5 w-full shrink-0 bg-black"}),c?ve.createElement("div",{className:"flex min-h-[1px] grow flex-col gap-4"},ve.createElement("div",{className:"text-primary-light text-[20px]"},n(`Error fetching ${u[i.length]} list`)),ve.createElement("div",{className:"grow bg-black p-4 text-[14px]"},c)):ve.createElement(Ma,{itemLabel:u[p+1],itemList:s,onItemClicked:e=>{m(!1),o((t=>[...t.slice(0,p+1),e]))}}))};const Ra=function({servicesManager:e,extensionManager:t}){const{t:a}=(0,Ne.Bd)("DataSourceConfiguration"),{show:n,hide:s}=(0,Ee.hS)(),{customizationService:r}=e.services,[i,o]=(0,ve.useState)(),[c,l]=(0,ve.useState)();(0,ve.useEffect)((()=>{let e=!0;const a=async()=>{const a=t.getActiveDataSourceDefinition();if(!a.configuration.configurationAPI)return;const{factory:n}=r.get(a.configuration.configurationAPI)??{};if(!n)return;const s=n(a.sourceName);o(s),l(null),s.getConfiguredItems().then((t=>{e&&l(t)}))},n=t.subscribe(t.EVENTS.ACTIVE_DATA_SOURCE_CHANGED,a);return a(),()=>{e=!1,n.unsubscribe()}}),[]);const u=(0,ve.useCallback)((()=>{n({content:xa,title:a("Configure Data Source"),contentProps:{configurationAPI:i,configuredItems:c,onHide:s}})}),[i,c]);return(0,ve.useEffect)((()=>{i&&c&&c.length!==i.getItemLabels().length&&u()}),[i,c,u]),c?ve.createElement("div",{className:"text-aqua-pale flex items-center overflow-hidden"},ve.createElement(Ee.In,{name:"settings",className:"mr-2.5 h-3.5 w-3.5 shrink-0 cursor-pointer",onClick:u}),c.map(((e,t)=>ve.createElement("div",{key:t,className:"flex overflow-hidden"},ve.createElement("div",{key:t,className:"overflow-hidden text-ellipsis whitespace-nowrap"},e.name),t!==c.length-1&&ve.createElement("div",{className:"px-2.5"},"|"))))):ve.createElement(ve.Fragment,null)};var Ca=function(e){return e[e.projects=0]="projects",e[e.locations=1]="locations",e[e.datasets=2]="datasets",e[e.dicomStores=3]="dicomStores",e}(Ca||{});const Pa="https://cloudresourcemanager.googleapis.com/v1",Aa="https://healthcare.googleapis.com/v1";class Oa{constructor(e,t,a){this._extensionManager=void 0,this._fetchOptions=void 0,this._dataSourceName=void 0,this.getItemLabels=()=>["Project","Location","Data set","DICOM store"],this._dataSourceName=e,this._extensionManager=a;const n=t.services.userAuthenticationService;this._fetchOptions={method:"GET",headers:n.getAuthorizationHeader()}}async initialize(){const e=`${Pa}/projects`,t=await Oa._doFetch(e,Ca.projects,this._fetchOptions);if(!t?.length)return[];return t.map((e=>({id:e.projectId,name:e.name,itemType:Ca.projects,url:`${Aa}/projects/${e.projectId}`})))}async setCurrentItem(e){const t=e;if(t.itemType===Ca.dicomStores){const e=`${t.url}/dicomWeb`,a=JSON.parse(JSON.stringify(this._extensionManager.getDataSourceDefinition(this._dataSourceName)));return a.configuration={...a.configuration,wadoUriRoot:e,qidoRoot:e,wadoRoot:e},this._extensionManager.updateDataSourceConfiguration(a.sourceName,a.configuration),[]}const a=t.itemType+1,n=`${Ca[a]}`,s=`${t.url}/${n}`,r=await Oa._doFetch(s,a,this._fetchOptions);if(!r?.length)return[];return r.map((e=>{const t=e.name.split("/");return{id:e.name,name:t[t.length-1],itemType:a,url:`${Aa}/${e.name}`}}))}async getConfiguredItems(){const e=this._extensionManager.getDataSourceDefinition(this._dataSourceName).configuration.wadoUriRoot,t=e.indexOf("projects"),a=e.substring(t).split("/"),n=[];for(let e=0;e<4&&2*(e+1)<a.length;e+=1)if(e===Ca.projects){const t=a[1],s=`${Pa}/projects/${t}`,r=(await Oa._doFetch(s,Ca.projects,this._fetchOptions))[0];n.push({id:r.projectId,name:r.name,itemType:e,url:`${Aa}/projects/${r.projectId}`})}else{const t=a.slice(0,2*e+2).join("/");n.push({id:t,name:a[2*e+1],itemType:e,url:`${Aa}/${t}`})}return n}static async _doFetch(e,t,a={},n={}){try{const s=new URL(e);s.search=new URLSearchParams(n).toString();const r=await fetch(s,a),i=await r.json();if(r.status>=200&&r.status<300&&null!=i){if(null!=i.nextPageToken){n.pageToken=i.nextPageToken;const s=await this._doFetch(e,t,a,n);i[Ca[t]]=i[Ca[t]].concat(s)}return i[Ca[t]]?i[Ca[t]]:i.name?[i]:[]}{const e=i?.error?.message||`Error returned from Google Cloud Healthcare: ${r.status} - ${r.statusText}`;throw new Error(e)}}catch(e){throw new Error(e?.message||"Error occurred during fetch request.")}}}var Ta=a(79717);const Fa=i.Ay.classes.MetadataProvider;const La=i.classes.MetadataProvider;const ka=({SeriesInstanceUID:e,StudyInstanceUID:t})=>{const{instances:a}=i.DicomMetadataStore.getSeries(t,e);if(!a?.length)return;const n=a[0].Modality;if(!n||"PT"!==n)return;const s=a.map((e=>e.imageId)),r=[];try{if(s.forEach((e=>{const t=function(e){const t=Fa.get("instance",e);if(!t)throw new Error("dicom metadata are required");if(void 0===t.SeriesDate||void 0===t.SeriesTime||void 0===t.CorrectedImage||void 0===t.Units||!t.RadiopharmaceuticalInformationSequence||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife||void 0===t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose||void 0===t.DecayCorrection||void 0===t.AcquisitionDate||void 0===t.AcquisitionTime||void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime&&void 0===t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime)throw new Error("required metadata are missing");void 0===t.PatientWeight&&console.warn("PatientWeight missing from PT instance metadata");const a={CorrectedImage:t.CorrectedImage,Units:t.Units,RadionuclideHalfLife:t.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadionuclideTotalDose:t.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadiopharmaceuticalStartDateTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,RadiopharmaceuticalStartTime:t.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,DecayCorrection:t.DecayCorrection,PatientWeight:t.PatientWeight,SeriesDate:t.SeriesDate,SeriesTime:t.SeriesTime,AcquisitionDate:t.AcquisitionDate,AcquisitionTime:t.AcquisitionTime};if(t[70531e3]||void 0!==t[70531e3]||t[70531009]||void 0!==t[70531009]){const e={SUVScaleFactor:t[70531e3],ActivityConcentrationScaleFactor:t[70531009]};a.PhilipsPETPrivateGroup=e}return t["0009100d"]&&void 0!==t["0009100d"]&&(a.GEPrivatePostInjectionDateTime=t["0009100d"]),t.FrameReferenceTime&&void 0!==t.FrameReferenceTime&&(a.FrameReferenceTime=t.FrameReferenceTime),t.ActualFrameDuration&&void 0!==t.ActualFrameDuration&&(a.ActualFrameDuration=t.ActualFrameDuration),t.PatientSex&&void 0!==t.PatientSex&&(a.PatientSex=t.PatientSex),t.PatientSize&&void 0!==t.PatientSize&&(a.PatientSize=t.PatientSize),a}(e);t&&r.push(t)})),!r.length)return;const e=(0,Ta.C)(r);r.forEach(((t,a)=>{La.addCustomMetadata(s[a],"scalingModule",e[a])}))}catch(e){console.log(e)}},Va={id:St,preRegistration:function({servicesManager:e,configuration:t={}}){const{stateSyncService:a}=e.services;i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.INSTANCES_ADDED,ka),i.DicomMetadataStore.subscribe(i.DicomMetadataStore.EVENTS.SERIES_UPDATED,ka),a.register("viewportGridStore",{clearOnModeExit:!0}),a.register("displaySetSelectorMap",{clearOnModeExit:!0}),a.register("hangingProtocolStageIndexMap",{clearOnModeExit:!0}),a.register("toggleHangingProtocol",{clearOnModeExit:!0}),a.register("viewportsByPosition",{clearOnModeExit:!0})},getDataSourcesModule:De,getLayoutTemplateModule:function({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n}){return[{name:"viewerLayout",id:"viewerLayout",component:function(s){return qe({servicesManager:e,extensionManager:t,commandsManager:a,hotkeysManager:n,...s})}}]},getPanelModule:mt,getHangingProtocolModule:Ea,getSopClassHandlerModule:At,getToolbarModule:function({commandsManager:e,servicesManager:t}){return[{name:"ohif.divider",defaultComponent:Ot,clickHandler:()=>{}},{name:"ohif.action",defaultComponent:jt,clickHandler:()=>{}},{name:"ohif.radioGroup",defaultComponent:jt,clickHandler:()=>{}},{name:"ohif.splitButton",defaultComponent:$t,clickHandler:()=>{}},{name:"ohif.layoutSelector",defaultComponent:Lt,clickHandler:(e,t,a)=>{}},{name:"ohif.toggle",defaultComponent:jt,clickHandler:()=>{}}]},getCommandsModule:Ia,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getStudiesForPatientByMRN:Je}}],getCustomizationModule:function({servicesManager:e,extensionManager:t}){return[{name:"helloPage",value:{id:"customRoutes",routes:[{path:"/custom",children:()=>ve.createElement("h1",{style:{color:"white"}},"Hello Custom Route")}]}},{name:"datasources",value:{id:"customRoutes",routes:[{path:"/datasources",children:Ua}]}},{name:"default",value:[{id:"ohif.overlayItem",content:function(e){if(this.condition&&!this.condition(e))return null;const{instance:t}=e,a=t&&this.attribute?t[this.attribute]:this.contentF&&"function"==typeof this.contentF?this.contentF(e):null;return a?ve.createElement("span",{className:"overlay-item flex flex-row",style:{color:this.color||void 0},title:this.title||""},this.label&&ve.createElement("span",{className:"mr-1 shrink-0"},this.label),ve.createElement("span",{className:"font-light"},a)):null}},{id:"ohif.contextMenu",transform:function(e){const t={...this};t.menus=this.menus.map((e=>({...e})));for(const a of t.menus){const{items:t}=a;a.items=[];for(const n of t)a.items.push(e.transform(n))}return t}},{id:"ohif.dataSourceConfigurationComponent",component:Ra.bind(null,{servicesManager:e,extensionManager:t})},{id:"ohif.dataSourceConfigurationAPI.google",factory:a=>new Oa(a,e,t)}]}]}}}}]);
//# sourceMappingURL=335.bundle.40f43c17485572a04dd6.js.map